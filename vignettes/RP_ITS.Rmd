---
title: "Interrupted Time Series Analysis"
author: "Tom Woodcock"
date: "`r Sys.Date()`"
output: pdf_document
---

Package repo commit: `r stringr::str_sub(system("git rev-parse HEAD", intern=TRUE), 1, 8)`

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  fig.path = "RP_ITS_Images/"
)

trim_readmission_analysis = FALSE
crop_readmission_analysis = TRUE
if(trim_readmission_analysis) {
  trim_30_day <- 1
  trim_90_day <- 3
} else {
  trim_30_day <- 0
  trim_90_day <- 0
}
if(crop_readmission_analysis) {
  crop_30_day <- 1
  crop_90_day <- 3
} else {
  crop_30_day <- 0
  crop_90_day <- 0
}

```

```{r dependencies, include = FALSE}
library(magrittr)
library(pglm)
library(lme4)
library(tidyverse)
```


```{r load-data}
load("../data-raw/hf_its_data.rda")

# Select only those variables needed for the analysis
hf_its_data <- hf_its_data %>% select(X_t, X_x, X_x_t, X_z, X_z_t, X_z_x, X_z_x_t,
                                             pseudoid, HF_primary, HF_any, sex, non_white,
                                             ln_age, ward_2, ward_3, ward_4, ward_5,
                                             starts_with("month_"), -month_12,
                                             hospital, imd_q,
                                             starts_with("allcausereadmission_"),
                                             starts_with("hfreadmission_"), death,
                                             los_dd, total_HF, wardsite, id_time, count)

# Convert sex and non_white variables to factors
hf_its_data <- hf_its_data %>% mutate(sex = factor(sex),
                                             non_white = factor(non_white))
```

```{r sense-check, include=FALSE}
hf_its_data <- hf_its_data %>% filter(wardsite != "CMH")

table(hf_its_data$id_time >= 43, hf_its_data$X_x , useNA = "always")

table(hf_its_data$id_time > 43, hf_its_data$X_x_t , useNA = "always")

table(hf_its_data$wardsite, hf_its_data$X_z , useNA = "always")

table(hf_its_data$id_time >= 43, hf_its_data$X_z_t , useNA = "always")

table(hf_its_data$id_time >= 43, hf_its_data$X_z_x , useNA = "always")

table(hf_its_data$id_time >= 43, hf_its_data$X_z_x_t , useNA = "always")

```

<!-- Discharges with HF as primary diagnosis, no control -->
```{r hf-prim-nocont, warning=FALSE, message=FALSE, include=F}
# 
# hf_prim_data <- hf_its_data %>% filter(wardsite == "NPH")
# hf_prim_data <- plm::pdata.frame(hf_prim_data, "pseudoid")
# 
# hf_prim_form <- Formula::Formula(HF_primary ~ offset(log(count)) + X_t + X_x + X_x_t + sex + non_white + ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 + month_3 + month_4 + month_5 + month_6 + month_7 + month_8 + month_9 + month_10 + month_11)
# 
# hf_prim_model <- pglm(formula = hf_prim_form, family = poisson(link = "log"), data = hf_prim_data, effect = "individual", model = "random")
# 
# summary(hf_prim_model)
# 
# knitr::kable(exp(hf_prim_model$estimate), col.names = c("IRR"))
```

<!-- Discharges with HF as primary diagnosis, with control -->
```{r hf-prim-cont, warning=T, message=T, include=FALSE}
# 
# hf_prim_data <- hf_its_data %>% filter(wardsite != "CMH")
# hf_prim_data <- plm::pdata.frame(hf_prim_data, "pseudoid")
# 
# hf_prim_form_cont <- Formula::Formula(HF_primary ~ offset(log(count)) + X_t + X_x + X_x_t + 
#                                         X_z + X_z_t + X_z_x + X_z_x_t + sex + non_white + 
#                                         ln_age + ward_2 + ward_3 + ward_4 + ward_5 + 
#                                         month_1 + month_2 + month_3 + month_4 + month_5 + 
#                                         month_6 + month_7 + month_8 + month_9 + month_10 +
#                                         month_11)
# 
# hf_prim_model_cont <- pglm(formula = hf_prim_form_cont, family = poisson(link = "log"), data = hf_prim_data, effect = "individual", model = "random")
# 
# summary(hf_prim_model_cont)
# 
# knitr::kable(exp(hf_prim_model_cont$estimate), col.names = c("IRR"))
```

<!-- Discharges with HF as any diagnosis, no control -->
```{r hf-any-nocont, warning=FALSE, message=FALSE, include=FALSE}
# 
# hf_any_data <- hf_its_data %>% filter(wardsite == "NPH")
# hf_any_data <- plm::pdata.frame(hf_any_data, "pseudoid")
# 
# hf_any_form <- Formula::Formula(HF_any ~ offset(log(count)) + X_t + X_x + X_x_t + sex + non_white + ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 + month_3 + month_4 + month_5 + month_6 + month_7 + month_8 + month_9 + month_10 + month_11)
# 
# hf_any_model <- pglm(formula = hf_any_form, family = poisson(link = "log"), data = hf_any_data, effect = "individual", model = "random")
# 
# summary(hf_any_model)
# 
# knitr::kable(exp(hf_any_model$estimate), col.names = c("IRR"))
```

<!-- Discharges with HF as any diagnosis, with control -->
```{r hf-any-cont, warning=T, message=T, include=FALSE}
# 
# hf_any_data <- hf_its_data %>% filter(wardsite != "CMH")
# hf_any_data <- plm::pdata.frame(hf_any_data, "pseudoid")
# 
# hf_any_form_cont <- Formula::Formula(HF_any ~ offset(log(count)) + X_t + X_x + X_x_t + 
#                                         X_z + X_z_t + X_z_x + X_z_x_t +
#                                         sex + non_white + 
#                                         ln_age + ward_2 + ward_3 + ward_4 + ward_5 + 
#                                         month_1 + month_2 + month_3 + month_4 + month_5 + 
#                                         month_6 + month_7 + month_8 + month_9 + month_10 +
#                                         month_11)
# 
# hf_any_model_cont <- pglm(formula = hf_any_form_cont, family = poisson(link = "log"), data = hf_any_data, effect = "individual", model = "random")
# 
# summary(hf_any_model_cont)
# 
# knitr::kable(exp(hf_any_model_cont$estimate), col.names = c("IRR"))
```

# Northwick Park Outcomes

## 7-day all cause readmission rate, following discharge with HF as any diagnosis, no control
```{r read7-all-nocont, warning=FALSE, message=FALSE}


# Create a dataset of all spells with HF diagnosis in any position, just for NPH,
# encode sex and non_white as dummy variables,
# set the count of number of spells to 1 for each row
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "NPH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
         )

# Mixed-effects poisson model: random effects for pseudoid
hf_read7_all_nc_model_glmer <- glmer(as.integer(allcausereadmission_7) ~ offset(log(total_HF)) + X_t + X_x + X_x_t +
                                       sexM + non_white1 +
                                       ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                       month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                       month_9 + month_10 + month_11 +
                                       (1 | pseudoid),
                                     hf_any_data_oc_nc,
                                     family = poisson(link = "log"),
                                     control=glmerControl(optimizer="bobyqa"))

summary(hf_read7_all_nc_model_glmer)

# Check dispersion
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

overdisp_fun(hf_read7_all_nc_model_glmer)

# Display IRRs
knitr::kable(exp(fixef(hf_read7_all_nc_model_glmer)), col.names = c("IRR"))
```

```{r read7-all-nocont-tmb, warning=FALSE, message=FALSE}

# Mixed-effects poisson model: random effects for pseudoid
hf_read7_all_nc_model_glmmTMB <- glmmTMB::glmmTMB(as.integer(allcausereadmission_7) ~
                                                  offset(log(total_HF)) +
                                                  X_t + X_x + X_x_t +
                                                  sexM + non_white1 +
                                                  ln_age + ward_2 + ward_3 + ward_4 + ward_5 + 
                                                  month_1 + month_2 + month_3 + month_4 +
                                                  month_5 + month_6 + month_7 + month_8 +
                                                  month_9 + month_10 + month_11 +
                                                  (1 | pseudoid),
                                                hf_any_data_oc_nc,
                                                family = poisson(link = "log")#,
                                                #control=glmerControl(optimizer="bobyqa")
                                                )

summary(hf_read7_all_nc_model_glmmTMB)

overdisp_fun(hf_read7_all_nc_model_glmmTMB)

# Display IRRs
knitr::kable(exp(fixef(hf_read7_all_nc_model_glmmTMB)$cond), col.names = c("IRR"))
```


<!-- 7-day all cause readmission rate, following discharge with HF as any diagnosis, with control -->
```{r read7-all-cont, warning=T, message=T, include=F}

#hf_any_data_oc_c <- hf_its_data %>% filter(wardsite != "CMH", HF_any == 1)
#hf_any_data_oc_c <- plm::pdata.frame(hf_any_data_oc_c, "pseudoid")

# hf_read7_all_form_cont <- Formula::Formula(allcausereadmission_7 ~ offset(log(total_HF)) + X_t + X_x + X_x_t + 
#                                         X_z + X_z_t + X_z_x + X_z_x_t + sex + non_white + 
#                                         ln_age + ward_2 + ward_3 + ward_4 + ward_5 + 
#                                         month_1 + month_2 + month_3 + month_4 + month_5 + 
#                                         month_6 + month_7 + month_8 + month_9 + month_10 +
#                                         month_11)

#hf_read7_all_model_cont <- pglm(formula = hf_read7_all_form_cont, family = poisson(link = "log"), data = hf_any_data_oc_c, effect = "individual", model = "random")
# 
# hf_read7_all_c_model_glmer <- glmer(allcausereadmission_7 ~ offset(log(total_HF)) + X_t + X_x + X_x_t + 
#                                         X_z + X_z_t + X_z_x + X_z_x_t +
#                                         sex + non_white +
#                                         ln_age + ward_2 + ward_3 + ward_4 + ward_5 +
#                                         month_1 + month_2 + month_3 + month_4 + month_5 +
#                                         month_6 + month_7 + month_8 + month_9 + month_10 +
#                                         month_11 + (1 | pseudoid), hf_any_data_oc_c, family = poisson, 
#                                      control=glmerControl(optimizer="bobyqa"))
# 
# summary(hf_read7_all_c_model_glmer)
# 
# knitr::kable(exp(fixef(hf_read7_all_c_model_glmer)), col.names = c("IRR"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r plot-7read}
# Make a copy of the data
covariates_data_any_oc_nc <- hf_any_data_oc_nc

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

# Run model predictions on this averaged data
prediction_output_7d <- predict(hf_read7_all_nc_model_glmer, newdata = data_new %>% select(-allcausereadmission_7), type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly readmission rate
read7_acts_preds <- data_new %>% cbind(prediction_output_7d) %>% group_by(id_time) %>% summarise(allcausereadmission_7 = sum(allcausereadmission_7), total_HF = n(), pred_out_7d = mean(prediction_output_7d)) %>% mutate(act_rate = allcausereadmission_7/total_HF)

# Plot the chart
read7_acts_preds %>% select(id_time, allcausereadmission_7, act_rate, pred_out_7d) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_7d), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")

```

\newpage
## 30-day all cause readmission rate, following discharge with HF as any diagnosis, no control
```{r read30-all-nocont, warning=FALSE, message=FALSE}


# Create a dataset of all spells with HF diagnosis in any position, just for NPH,
# encode sex and non_white as dummy variables,
# set the count of number of spells to 1 for each row
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "NPH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
         )

# Mixed-effects poisson model: random effects for pseudoid
hf_read30_all_nc_model_glmer <- glmer(as.integer(allcausereadmission_30) ~ offset(log(total_HF)) + X_t + X_x + X_x_t +
                                       sexM + non_white1 +
                                       ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                       month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                       month_9 + month_10 + month_11 +
                                       (1 | pseudoid),
                                     hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_30_day),
                                     family = poisson(link = "log"),
                                     control=glmerControl(optimizer="bobyqa"))

summary(hf_read30_all_nc_model_glmer)

# Check dispersion
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

overdisp_fun(hf_read30_all_nc_model_glmer)

# Display IRRs
knitr::kable(exp(fixef(hf_read30_all_nc_model_glmer)), col.names = c("IRR"))
```

```{r read30-all-nocont-tmb, warning=FALSE, message=FALSE}

# Mixed-effects poisson model: random effects for pseudoid
hf_read30_all_nc_model_glmmTMB <- glmmTMB::glmmTMB(as.integer(allcausereadmission_30) ~
                                                  offset(log(total_HF)) +
                                                  X_t + X_x + X_x_t +
                                                  sexM + non_white1 +
                                                  ln_age + ward_2 + ward_3 + ward_4 + ward_5 + 
                                                  month_1 + month_2 + month_3 + month_4 +
                                                  month_5 + month_6 + month_7 + month_8 +
                                                  month_9 + month_10 + month_11 +
                                                  (1 | pseudoid),
                                                hf_any_data_oc_nc,
                                                family = poisson(link = "log")#,
                                                #control=glmerControl(optimizer="bobyqa")
                                                )

summary(hf_read30_all_nc_model_glmmTMB)

overdisp_fun(hf_read30_all_nc_model_glmmTMB)

# Display IRRs
knitr::kable(exp(fixef(hf_read30_all_nc_model_glmmTMB)$cond), col.names = c("IRR"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r plot-30read}
# Make a copy of the data
covariates_data_any_oc_nc <- hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_30_day)

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

# Run model predictions on this averaged data
prediction_output_30d <- predict(hf_read30_all_nc_model_glmer, newdata = data_new %>% select(-allcausereadmission_30), type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly readmission rate
read30_acts_preds <- data_new %>% cbind(prediction_output_30d) %>% group_by(id_time) %>% summarise(allcausereadmission_30 = sum(allcausereadmission_30), total_HF = n(), pred_out_30d = mean(prediction_output_30d)) %>% mutate(act_rate = allcausereadmission_30/total_HF)

# Plot the chart
read30_acts_preds %>% select(id_time, allcausereadmission_30, act_rate, pred_out_30d) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_30d), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")

```

\newpage
## 90-day all cause readmission rate, following discharge with HF as any diagnosis, no control
```{r read90-all-nocont, warning=FALSE, message=FALSE}


# Create a dataset of all spells with HF diagnosis in any position, just for NPH,
# encode sex and non_white as dummy variables,
# set the count of number of spells to 1 for each row
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "NPH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
                )

# Mixed-effects poisson model: random effects for pseudoid
hf_read90_all_nc_model_glmer <- glmer(as.integer(allcausereadmission_90) ~ offset(log(total_HF)) + 
                                        X_t + X_x + X_x_t +
                                        sexM + non_white1 +
                                        ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 +
                                        month_2 +
                                        month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                        month_9 + month_10 + month_11 +
                                        (1 | pseudoid),
                                      hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_90_day),
                                      family = poisson(link = "log"),
                                      control=glmerControl(optimizer="bobyqa"))

summary(hf_read90_all_nc_model_glmer)

# Check dispersion
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

overdisp_fun(hf_read90_all_nc_model_glmer)

# Display IRRs
knitr::kable(exp(fixef(hf_read90_all_nc_model_glmer)), col.names = c("IRR"))
```

```{r read90-all-nocont-tmb, warning=FALSE, message=FALSE}

# Mixed-effects poisson model: random effects for pseudoid
hf_read90_all_nc_model_glmmTMB <- glmmTMB::glmmTMB(as.integer(allcausereadmission_90) ~
                                                  offset(log(total_HF)) +
                                                  X_t + X_x + X_x_t +
                                                  sexM + non_white1 +
                                                  ln_age + ward_2 + ward_3 + ward_4 + ward_5 + 
                                                  month_1 + month_2 + month_3 + month_4 +
                                                  month_5 + month_6 + month_7 + month_8 +
                                                  month_9 + month_10 + month_11 +
                                                  (1 | pseudoid),
                                                hf_any_data_oc_nc,
                                                family = poisson(link = "log")#,
                                                #control=glmerControl(optimizer="bobyqa")
                                                )

summary(hf_read90_all_nc_model_glmmTMB)

overdisp_fun(hf_read90_all_nc_model_glmmTMB)

# Display IRRs
knitr::kable(exp(fixef(hf_read90_all_nc_model_glmmTMB)$cond), col.names = c("IRR"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r plot-90read}
# Make a copy of the data
covariates_data_any_oc_nc <- hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_90_day)

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

# Run model predictions on this averaged data
prediction_output_90d <- predict(hf_read90_all_nc_model_glmer, newdata = data_new %>% select(-allcausereadmission_90), type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly readmission rate
read90_acts_preds <- data_new %>% cbind(prediction_output_90d) %>% group_by(id_time) %>% summarise(allcausereadmission_90 = sum(allcausereadmission_90), total_HF = n(), pred_out_90d = mean(prediction_output_90d)) %>% mutate(act_rate = allcausereadmission_90/total_HF)

# Plot the chart
read90_acts_preds %>% select(id_time, allcausereadmission_90, act_rate, pred_out_90d) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_90d), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")

```

\newpage
## Mortality, following discharge with HF as any diagnosis, no control - without the ward variables
```{r mort-nocont-noward, warning=TRUE, message=TRUE}
# Create dataset for the regression analysis
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "NPH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
         )

# Fixed-effects poisson model
death_nc_model_glm_nw <- glm(as.integer(death) ~ offset(log(total_HF)) + X_t + X_x + X_x_t +
                            sexM + non_white1 + ln_age +
                            #ward_2 + ward_3 + ward_4 + ward_5 +
                            month_1 + month_2 + month_3 + month_4 + month_5 + month_6 +
                            month_7 + month_8 + month_9 + month_10 + month_11,
                          hf_any_data_oc_nc,
                          family = poisson(link = "log"))

summary(death_nc_model_glm_nw)
summary(death_nc_model_glm_nw)$dispersion
overdisp_fun(death_nc_model_glm_nw)

knitr::kable(Epi::ci.lin(death_nc_model_glm_nw, Exp=T))
```

Plot for the mortality model with no ward covariates

```{r plot-death-noward}
covariates_data_any_oc_nc <- hf_any_data_oc_nc

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

prediction_output_death_nw <- predict(death_nc_model_glm_nw, type = "response", data_new %>% select(-death))

death_acts_preds_nw <- data_new %>% cbind(prediction_output_death_nw) %>% group_by(id_time) %>% summarise(death = sum(death), total_HF = n(), pred_out_death = mean(prediction_output_death_nw)) %>% mutate(act_rate = death/total_HF)

death_acts_preds_nw %>% select(id_time, death, act_rate, pred_out_death) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) + ggplot2::geom_line(ggplot2::aes(y=pred_out_death), colour = "blue") + ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")
```


\newpage
## Mortality, following discharge with HF as any diagnosis, no control - with the ward variables
```{r mort-nocont, warning=TRUE, message=TRUE}
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "NPH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
                )

death_nc_model_glm <- glm(as.integer(death) ~ offset(log(total_HF)) +
                            X_t + X_x + X_x_t +
                            sexM + non_white1 + ln_age +
                            ward_2 + ward_3 + ward_4 + ward_5 +
                            month_1 + month_2 + month_3 + month_4 + month_5 + month_6 +
                            month_7 + month_8 + month_9 + month_10 + month_11,
                          hf_any_data_oc_nc,
                          family = poisson(link = "log"))

summary(death_nc_model_glm)
summary(death_nc_model_glm)$dispersion
overdisp_fun(death_nc_model_glm)

knitr::kable(Epi::ci.lin(death_nc_model_glm, Exp=T))
```


```{r plot-death}
covariates_data_any_oc_nc <- hf_any_data_oc_nc

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

prediction_output_death <- predict(death_nc_model_glm, type = "response", data_new %>% select(-death))

death_acts_preds <- data_new %>% cbind(prediction_output_death) %>% group_by(id_time) %>% summarise(death = sum(death), total_HF = n(), pred_out_death = mean(prediction_output_death)) %>% mutate(act_rate = death/total_HF)

death_acts_preds %>% select(id_time, death, act_rate, pred_out_death) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) + ggplot2::geom_line(ggplot2::aes(y=pred_out_death), colour = "blue") + ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")
```

The problem with the fit is likely due to the following: death = 0 whenever ward_5 = 1, and ward_5 = 0 identically before the intervention (i.e. when X_x = 0). This is shown in the following tables.

```{r ward-mortality-table}
ward_death_data <- hf_any_data_oc_nc %>% select(death, starts_with("ward"), X_x) %>%
  mutate(ward = factor(case_when(
    ward_2 == 1 ~ 2,
    ward_3 == 1 ~ 3,
    ward_4 == 1 ~ 4,
    ward_5 == 1 ~ 5,
    TRUE ~ 1
  )))


tab1 <- table(ward_death_data %>% filter(X_x == 0) %>% pull(ward),
                        ward_death_data %>% filter(X_x == 0) %>% pull(death))
#tab1 <- set_colnames(tab1, c("row_labels", "Did not die", "Died"))
#tab1$row_labels <- c("ward 1", "ward 2", "ward 3", "ward 4", "ward 5", "total")
tab1[is.na(tab1)] <- 0
knitr::kable(tab1, caption = "Before intervention")

tab2 <- table(ward_death_data %>% filter(X_x == 1) %>% pull(ward),
                        ward_death_data %>% filter(X_x == 1) %>% pull(death))
#tab2 <- set_colnames(tab2, c("row_labels", "Did not die", "Died"))
#tab2$row_labels <- c("ward 1", "ward 2", "ward 3", "ward 4", "ward 5", "total")
tab2[is.na(tab2)] <- 0
knitr::kable(tab2, caption = "After intervention")
```

\newpage
## Mortality, following discharge with HF as any diagnosis, no control - with the ward 5 spells removed
```{r mort-nocont-nw5, warning=TRUE, message=TRUE}
hf_any_data_oc_nc_nw5 <- hf_its_data %>% filter(wardsite == "NPH", HF_any == 1, ward_5 == 0) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
                )

death_nc_model_glm_nw5 <- glm(as.integer(death) ~ offset(log(total_HF)) +
                            X_t + X_x + X_x_t +
                            sexM + non_white1 + ln_age +
                            ward_2 + ward_3 + ward_4 +
                            month_1 + month_2 + month_3 + month_4 + month_5 + month_6 +
                            month_7 + month_8 + month_9 + month_10 + month_11,
                          hf_any_data_oc_nc_nw5,
                          family = poisson(link = "log"))

summary(death_nc_model_glm_nw5)
summary(death_nc_model_glm_nw5)$dispersion
overdisp_fun(death_nc_model_glm_nw5)

knitr::kable(Epi::ci.lin(death_nc_model_glm_nw5, Exp=T))
```


```{r plot-death-nw5}
covariates_data_any_oc_nc_nw5 <- hf_any_data_oc_nc_nw5

# Create new dataset with averaged values of all covariates
data_new_nw5 <- covariates_data_any_oc_nc_nw5 %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

prediction_output_death_nw5 <- predict(death_nc_model_glm_nw5, type = "response", data_new_nw5 %>% select(-death))

death_acts_preds_nw5 <- data_new_nw5 %>% cbind(prediction_output_death_nw5) %>% group_by(id_time) %>% summarise(death = sum(death), total_HF = n(), pred_out_death = mean(prediction_output_death_nw5)) %>% mutate(act_rate = death/total_HF)

death_acts_preds_nw5 %>% select(id_time, death, act_rate, pred_out_death) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) + ggplot2::geom_line(ggplot2::aes(y=pred_out_death), colour = "blue") + ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")
```


\newpage
## Mortality, following discharge with HF as any diagnosis, no control - with ward 5 (Other) merged with 4 (Medicine)
```{r mort-nocont-wm, warning=TRUE, message=TRUE}
hf_any_data_oc_nc_wm <- hf_its_data %>% filter(wardsite == "NPH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0),
                #total_HF = 1,
                ward_4 = if_else(ward_5 == 1, 1L, ward_4))

death_nc_model_glm_wm <- glm(as.integer(death) ~ offset(log(total_HF)) +
                            X_t + X_x + X_x_t +
                            sexM + non_white1 + ln_age +
                            ward_2 + ward_3 + ward_4 +
                            month_1 + month_2 + month_3 + month_4 + month_5 + month_6 +
                            month_7 + month_8 + month_9 + month_10 + month_11,
                          hf_any_data_oc_nc_wm,
                          family = poisson(link = "log"))

summary(death_nc_model_glm_wm)
summary(death_nc_model_glm_wm)$dispersion
overdisp_fun(death_nc_model_glm_wm)

knitr::kable(Epi::ci.lin(death_nc_model_glm_wm, Exp=T))
```


```{r plot-death-wm}
covariates_data_any_oc_nc_wm <- hf_any_data_oc_nc_wm

# Create new dataset with averaged values of all covariates
data_new_wm <- covariates_data_any_oc_nc_wm %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4)) %>%
  ungroup()

prediction_output_death_wm <- predict(death_nc_model_glm_wm, type = "response", data_new_wm %>% select(-death))

death_acts_preds_wm <- data_new_wm %>% cbind(prediction_output_death_wm) %>% group_by(id_time) %>% summarise(death = sum(death), total_HF = n(), pred_out_death = mean(prediction_output_death_wm)) %>% mutate(act_rate = death/total_HF)

death_acts_preds_wm %>% select(id_time, death, act_rate, pred_out_death) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) + ggplot2::geom_line(ggplot2::aes(y=pred_out_death), colour = "blue") + ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")
```


\newpage
## LOS with HF as any diagnosis, no control
```{r los-nocont, warning=FALSE, message=FALSE}


# Create a dataset of all spells with HF diagnosis in any position, just for NPH,
# encode sex and non_white as dummy variables,
# set the count of number of spells to 1 for each row
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "NPH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
                )

# Mixed-effects linear model: random effects for pseudoid
hf_los_nc_model_lmer <- lmer(los_dd ~ X_t + X_x + X_x_t +
                                       sexM + non_white1 +
                                       ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                       month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                       month_9 + month_10 + month_11 +
                                       (1 | pseudoid),
                                     hf_any_data_oc_nc)

summary(hf_los_nc_model_lmer)


# Display coefficients
knitr::kable(fixef(hf_los_nc_model_lmer), col.names = c("coeffs"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r plot-los}
# Make a copy of the data
covariates_data_any_oc_nc <- hf_any_data_oc_nc

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

# Run model predictions on this averaged data
prediction_output_los <- predict(hf_los_nc_model_lmer, newdata = data_new %>% select(-los_dd), type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly readmission rate
los_acts_preds <- data_new %>% cbind(prediction_output_los) %>% group_by(id_time) %>% summarise(los_tot = sum(los_dd), total_HF = n(), pred_out_los = mean(prediction_output_los)) %>% mutate(act_los = los_tot/total_HF)

# Plot the chart
los_acts_preds %>% select(id_time, los_tot, act_los, pred_out_los) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_los), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_los), colour = "black")

```
\newpage
## Facet plot

```{r join-data, fig.height=8, fig.width=5}
outcome_predictions <- read7_acts_preds %>% rename (act_rate_7dr = act_rate) %>%
  left_join(read30_acts_preds %>% select(-total_HF) %>% rename(act_rate_30dr = act_rate),
            by = c("id_time" = "id_time")) %>%
  left_join(read90_acts_preds %>% select(-total_HF) %>% rename(act_rate_90dr = act_rate),
            by = c("id_time" = "id_time")) %>%
  left_join(death_acts_preds_wm %>% select(-total_HF) %>% rename(act_rate_death = act_rate),
            by = c("id_time" = "id_time")) %>%
  left_join(los_acts_preds %>% select(-total_HF),
            by = c("id_time" = "id_time"))

outcomes_predictions_tidy_1 <- outcome_predictions %>% select(id_time, pred_out_7d, act_rate_7dr,
                                                            pred_out_30d, act_rate_30dr,
                                                            pred_out_90d, act_rate_90dr,
                                                            pred_out_death, act_rate_death,
                                                            pred_out_los, act_los) %>%
  gather(key = "measure", value = "outcome", -id_time) %>%
  mutate(outcome = if_else(!str_detect(measure, "los"), outcome*100, outcome))

outcomes_predictions_tidy_2 <- outcomes_predictions_tidy_1 %>% mutate(prediction = str_detect(measure, "pred"), measure_type = case_when(
  str_detect(measure, "7d") ~ "7d readmission (%)",
  str_detect(measure, "30d") ~ "30d readmission (%)",
  str_detect(measure, "90d") ~ "90d readmission (%)",
  str_detect(measure, "death") ~ "Mortality (%)",
  str_detect(measure, "los") ~ "Length of stay (days)",
)) %>%
  mutate(measure_type = factor(measure_type,
                               levels = c("7d readmission (%)", "30d readmission (%)",
                                          "90d readmission (%)", "Mortality (%)",
                                          "Length of stay (days)"))) %>%
  select(-measure) %>%
  spread(prediction, outcome) %>% rename(actual = `FALSE`, prediction = `TRUE`) %>%
  filter(!is.na(actual))


outcomes_predictions_tidy_2 %>% ggplot(aes(x = id_time)) + geom_point(aes(y = actual)) + geom_line(aes(y = prediction)) + facet_grid(rows = vars(measure_type), scales = "free")
```

\newpage
# Ealing Outcomes

## 7-day all cause readmission rate, following discharge with HF as any diagnosis, no control
```{r eh-read7-all-nocont, warning=FALSE, message=FALSE}


# Create a dataset of all spells with HF diagnosis in any position, just for EH,
# encode sex and non_white as dummy variables,
# set the count of number of spells to 1 for each row
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "EH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
         )

# Mixed-effects poisson model: random effects for pseudoid
hf_read7_all_nc_model_glmer <- glmer(as.integer(allcausereadmission_7) ~ offset(log(total_HF)) + X_t + X_x + X_x_t +
                                       sexM + non_white1 +
                                       ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                       month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                       month_9 + month_10 + month_11 +
                                       (1 | pseudoid),
                                     hf_any_data_oc_nc,
                                     family = poisson(link = "log"),
                                     control=glmerControl(optimizer="bobyqa"))

summary(hf_read7_all_nc_model_glmer)

# Check dispersion
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

overdisp_fun(hf_read7_all_nc_model_glmer)

# Display IRRs
knitr::kable(exp(fixef(hf_read7_all_nc_model_glmer)), col.names = c("IRR"))
```

```{r eh-read7-all-nocont-tmb, warning=FALSE, message=FALSE}

# Mixed-effects poisson model: random effects for pseudoid
hf_read7_all_nc_model_glmmTMB <- glmmTMB::glmmTMB(as.integer(allcausereadmission_7) ~
                                                  offset(log(total_HF)) +
                                                  X_t + X_x + X_x_t +
                                                  sexM + non_white1 +
                                                  ln_age + ward_2 + ward_3 + ward_4 + ward_5 + 
                                                  month_1 + month_2 + month_3 + month_4 +
                                                  month_5 + month_6 + month_7 + month_8 +
                                                  month_9 + month_10 + month_11 +
                                                  (1 | pseudoid),
                                                hf_any_data_oc_nc,
                                                family = poisson(link = "log")#,
                                                #control=glmerControl(optimizer="bobyqa")
                                                )

summary(hf_read7_all_nc_model_glmmTMB)

overdisp_fun(hf_read7_all_nc_model_glmmTMB)

# Display IRRs
knitr::kable(exp(fixef(hf_read7_all_nc_model_glmmTMB)$cond), col.names = c("IRR"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r eh-plot-7read}
# Make a copy of the data
covariates_data_any_oc_nc <- hf_any_data_oc_nc

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

# Run model predictions on this averaged data
prediction_output_7d <- predict(hf_read7_all_nc_model_glmer, newdata = data_new %>% select(-allcausereadmission_7), type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly readmission rate
read7_acts_preds <- data_new %>% cbind(prediction_output_7d) %>% group_by(id_time) %>% summarise(allcausereadmission_7 = sum(allcausereadmission_7), total_HF = n(), pred_out_7d = mean(prediction_output_7d)) %>% mutate(act_rate = allcausereadmission_7/total_HF)

# Plot the chart
read7_acts_preds %>% select(id_time, allcausereadmission_7, act_rate, pred_out_7d) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_7d), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")

```

\newpage
## 30-day all cause readmission rate, following discharge with HF as any diagnosis, no control
```{r eh-read30-all-nocont, warning=FALSE, message=FALSE}


# Create a dataset of all spells with HF diagnosis in any position, just for EH,
# encode sex and non_white as dummy variables,
# set the count of number of spells to 1 for each row
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "EH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
         )

# Mixed-effects poisson model: random effects for pseudoid
hf_read30_all_nc_model_glmer <- glmer(as.integer(allcausereadmission_30) ~ offset(log(total_HF)) + X_t + X_x + X_x_t +
                                       sexM + non_white1 +
                                       ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                       month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                       month_9 + month_10 + month_11 +
                                       (1 | pseudoid),
                                     hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_30_day),
                                     family = poisson(link = "log"),
                                     control=glmerControl(optimizer="bobyqa"))

summary(hf_read30_all_nc_model_glmer)

# Check dispersion
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

overdisp_fun(hf_read30_all_nc_model_glmer)

# Display IRRs
knitr::kable(exp(fixef(hf_read30_all_nc_model_glmer)), col.names = c("IRR"))
```

```{r eh-read30-all-nocont-tmb, warning=FALSE, message=FALSE}

# Mixed-effects poisson model: random effects for pseudoid
hf_read7_all_nc_model_glmmTMB <- glmmTMB::glmmTMB(as.integer(allcausereadmission_30) ~
                                                  offset(log(total_HF)) +
                                                  X_t + X_x + X_x_t +
                                                  sexM + non_white1 +
                                                  ln_age + ward_2 + ward_3 + ward_4 + ward_5 + 
                                                  month_1 + month_2 + month_3 + month_4 +
                                                  month_5 + month_6 + month_7 + month_8 +
                                                  month_9 + month_10 + month_11 +
                                                  (1 | pseudoid),
                                                hf_any_data_oc_nc,
                                                family = poisson(link = "log")#,
                                                #control=glmerControl(optimizer="bobyqa")
                                                )

summary(hf_read30_all_nc_model_glmmTMB)

overdisp_fun(hf_read30_all_nc_model_glmmTMB)

# Display IRRs
knitr::kable(exp(fixef(hf_read30_all_nc_model_glmmTMB)$cond), col.names = c("IRR"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r eh-plot-30read}
# Make a copy of the data
covariates_data_any_oc_nc <- hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_30_day)

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

# Run model predictions on this averaged data
prediction_output_30d <- predict(hf_read30_all_nc_model_glmer, newdata = data_new %>% select(-allcausereadmission_30), type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly readmission rate
read30_acts_preds <- data_new %>% cbind(prediction_output_30d) %>% group_by(id_time) %>% summarise(allcausereadmission_30 = sum(allcausereadmission_30), total_HF = n(), pred_out_30d = mean(prediction_output_30d)) %>% mutate(act_rate = allcausereadmission_30/total_HF)

# Plot the chart
read30_acts_preds %>% select(id_time, allcausereadmission_30, act_rate, pred_out_30d) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_30d), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")

```

\newpage
## 90-day all cause readmission rate, following discharge with HF as any diagnosis, no control
```{r eh-read90-all-nocont, warning=FALSE, message=FALSE}


# Create a dataset of all spells with HF diagnosis in any position, just for EH,
# encode sex and non_white as dummy variables,
# set the count of number of spells to 1 for each row
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "EH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
                )

# Mixed-effects poisson model: random effects for pseudoid
hf_read90_all_nc_model_glmer <- glmer(as.integer(allcausereadmission_90) ~ offset(log(total_HF)) +
                                        X_t + X_x + X_x_t +
                                        sexM + non_white1 +
                                        ln_age + ward_2 + ward_3 + ward_4 + ward_5 + 
                                        month_1 + month_2 + month_3 + month_4 +
                                        month_5 + month_6 + month_7 + month_8 +
                                        month_9 + month_10 + month_11 +
                                        (1 | pseudoid),
                                      hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_90_day),
                                      family = poisson(link = "log"),
                                      control=glmerControl(optimizer="bobyqa"))

summary(hf_read90_all_nc_model_glmer)

# Check dispersion
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

overdisp_fun(hf_read90_all_nc_model_glmer)

# Display IRRs
knitr::kable(exp(fixef(hf_read90_all_nc_model_glmer)), col.names = c("IRR"))
```

```{r eh-read90-all-nocont-tmb, warning=FALSE, message=FALSE}

# Mixed-effects poisson model: random effects for pseudoid
hf_read90_all_nc_model_glmmTMB <- glmmTMB::glmmTMB(as.integer(allcausereadmission_90) ~
                                                  offset(log(total_HF)) +
                                                  X_t + X_x + X_x_t +
                                                  sexM + non_white1 +
                                                  ln_age + ward_2 + ward_3 + ward_4 + ward_5 + 
                                                  month_1 + month_2 + month_3 + month_4 +
                                                  month_5 + month_6 + month_7 + month_8 +
                                                  month_9 + month_10 + month_11 +
                                                  (1 | pseudoid),
                                                hf_any_data_oc_nc,
                                                family = poisson(link = "log")#,
                                                #control=glmerControl(optimizer="bobyqa")
                                                )

summary(hf_read90_all_nc_model_glmmTMB)

overdisp_fun(hf_read90_all_nc_model_glmmTMB)

# Display IRRs
knitr::kable(exp(fixef(hf_read90_all_nc_model_glmmTMB)$cond), col.names = c("IRR"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r eh-plot-90read}
# Make a copy of the data
covariates_data_any_oc_nc <- hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_90_day)

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

# Run model predictions on this averaged data
prediction_output_90d <- predict(hf_read90_all_nc_model_glmer, newdata = data_new %>% select(-allcausereadmission_90), type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly readmission rate
read90_acts_preds <- data_new %>% cbind(prediction_output_90d) %>% group_by(id_time) %>% summarise(allcausereadmission_90 = sum(allcausereadmission_90), total_HF = n(), pred_out_90d = mean(prediction_output_90d)) %>% mutate(act_rate = allcausereadmission_90/total_HF)

# Plot the chart
read90_acts_preds %>% select(id_time, allcausereadmission_90, act_rate, pred_out_90d) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_90d), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")

```

\newpage
## Mortality, following discharge with HF as any diagnosis, no control - without the ward variables
```{r eh-mort-nocont-noward, warning=TRUE, message=TRUE}
# Create dataset for the regression analysis
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "EH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
                )

# Fixed-effects poisson model
death_nc_model_glm_nw <- glm(as.integer(death) ~ offset(log(total_HF)) + X_t + X_x + X_x_t +
                            sexM + non_white1 + ln_age +
                            #ward_2 + ward_3 + ward_4 + ward_5 +
                            month_1 + month_2 + month_3 + month_4 + month_5 + month_6 +
                            month_7 + month_8 + month_9 + month_10 + month_11,
                          hf_any_data_oc_nc,
                          family = poisson(link = "log"))

summary(death_nc_model_glm_nw)
summary(death_nc_model_glm_nw)$dispersion
overdisp_fun(death_nc_model_glm_nw)

knitr::kable(Epi::ci.lin(death_nc_model_glm_nw, Exp=T))
```

Plot for the mortality model with no ward covariates

```{r eh-plot-death-noward}
covariates_data_any_oc_nc <- hf_any_data_oc_nc

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

prediction_output_death_nw <- predict(death_nc_model_glm_nw, type = "response", data_new %>% select(-death))

death_acts_preds_nw <- data_new %>% cbind(prediction_output_death_nw) %>% group_by(id_time) %>% summarise(death = sum(death), total_HF = n(), pred_out_death = mean(prediction_output_death_nw)) %>% mutate(act_rate = death/total_HF)

death_acts_preds_nw %>% select(id_time, death, act_rate, pred_out_death) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) + ggplot2::geom_line(ggplot2::aes(y=pred_out_death), colour = "blue") + ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")
```

\newpage
## Mortality, following discharge with HF as any diagnosis, no control - with the ward variables
```{r eh-mort-nocont, warning=TRUE, message=TRUE}
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "EH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
                )

death_nc_model_glm <- glm(as.integer(death) ~ offset(log(total_HF)) +
                            X_t + X_x + X_x_t +
                            sexM + non_white1 + ln_age +
                            ward_2 + ward_3 + ward_4 + ward_5 +
                            month_1 + month_2 + month_3 + month_4 + month_5 + month_6 +
                            month_7 + month_8 + month_9 + month_10 + month_11,
                          hf_any_data_oc_nc,
                          family = poisson(link = "log"))

summary(death_nc_model_glm)
summary(death_nc_model_glm)$dispersion
overdisp_fun(death_nc_model_glm)

knitr::kable(Epi::ci.lin(death_nc_model_glm, Exp=T))
```


```{r eh-plot-death}
covariates_data_any_oc_nc <- hf_any_data_oc_nc

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

prediction_output_death <- predict(death_nc_model_glm, type = "response", data_new %>% select(-death))

death_acts_preds <- data_new %>% cbind(prediction_output_death) %>% group_by(id_time) %>% summarise(death = sum(death), total_HF = n(), pred_out_death = mean(prediction_output_death)) %>% mutate(act_rate = death/total_HF)

death_acts_preds %>% select(id_time, death, act_rate, pred_out_death) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) + ggplot2::geom_line(ggplot2::aes(y=pred_out_death), colour = "blue") + ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")
```



Table of mortality by discharge ward
```{r eh-ward-mortality-table}
ward_death_data <- hf_any_data_oc_nc %>% select(death, starts_with("ward"), X_x) %>%
  mutate(ward = factor(case_when(
    ward_2 == 1 ~ 2,
    ward_3 == 1 ~ 3,
    ward_4 == 1 ~ 4,
    ward_5 == 1 ~ 5,
    TRUE ~ 1
  )))


tab1 <- table(ward_death_data %>% filter(X_x == 0) %>% pull(ward),
                        ward_death_data %>% filter(X_x == 0) %>% pull(death))
#tab1 <- set_colnames(tab1, c("row_labels", "Did not die", "Died"))
#tab1$row_labels <- c("ward 1", "ward 2", "ward 3", "ward 4", "ward 5", "total")
tab1[is.na(tab1)] <- 0
knitr::kable(tab1, caption = "Before intervention")

tab2 <- table(ward_death_data %>% filter(X_x == 1) %>% pull(ward),
                        ward_death_data %>% filter(X_x == 1) %>% pull(death))
#tab2 <- set_colnames(tab2, c("row_labels", "Did not die", "Died"))
#tab2$row_labels <- c("ward 1", "ward 2", "ward 3", "ward 4", "ward 5", "total")
tab2[is.na(tab2)] <- 0
knitr::kable(tab2, caption = "After intervention")
```


\newpage
## Mortality, following discharge with HF as any diagnosis, no control - with the ward 5 spells removed
```{r eh-mort-nocont-nw5, warning=TRUE, message=TRUE}
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "EH", HF_any == 1, ward_5 == 0) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
         )

death_nc_model_glm_nw5 <- glm(as.integer(death) ~ offset(log(total_HF)) +
                            X_t + X_x + X_x_t +
                            sexM + non_white1 + ln_age +
                            ward_2 + ward_3 + ward_4 +
                            month_1 + month_2 + month_3 + month_4 + month_5 + month_6 +
                            month_7 + month_8 + month_9 + month_10 + month_11,
                          hf_any_data_oc_nc,
                          family = poisson(link = "log"))

summary(death_nc_model_glm_nw5)
summary(death_nc_model_glm_nw5)$dispersion
overdisp_fun(death_nc_model_glm_nw5)

knitr::kable(Epi::ci.lin(death_nc_model_glm_nw5, Exp=T))
```


```{r eh-plot-death-nw5}
covariates_data_any_oc_nc_nw5 <- hf_any_data_oc_nc_nw5

# Create new dataset with averaged values of all covariates
data_new_nw5 <- covariates_data_any_oc_nc_nw5 %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

prediction_output_death_nw5 <- predict(death_nc_model_glm_nw5, type = "response", data_new_nw5 %>% select(-death))

death_acts_preds_nw5 <- data_new_nw5 %>% cbind(prediction_output_death_nw5) %>% group_by(id_time) %>% summarise(death = sum(death), total_HF = n(), pred_out_death = mean(prediction_output_death_nw5)) %>% mutate(act_rate = death/total_HF)

death_acts_preds_nw5 %>% select(id_time, death, act_rate, pred_out_death) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) + ggplot2::geom_line(ggplot2::aes(y=pred_out_death), colour = "blue") + ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")
```


\newpage
## Mortality, following discharge with HF as any diagnosis, no control - with ward 5 (Other) merged with 4 (Medicine)
```{r eh-mort-nocont-wm, warning=TRUE, message=TRUE}
hf_any_data_oc_nc_wm <- hf_its_data %>% filter(wardsite == "EH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0),
                #total_HF = 1,
                ward_4 = if_else(ward_5 == 1, 1L, ward_4))

death_nc_model_glm_wm <- glm(as.integer(death) ~ offset(log(total_HF)) +
                            X_t + X_x + X_x_t +
                            sexM + non_white1 + ln_age +
                            ward_2 + ward_3 + ward_4 +
                            month_1 + month_2 + month_3 + month_4 + month_5 + month_6 +
                            month_7 + month_8 + month_9 + month_10 + month_11,
                          hf_any_data_oc_nc_wm,
                          family = poisson(link = "log"))

summary(death_nc_model_glm_wm)
summary(death_nc_model_glm_wm)$dispersion
overdisp_fun(death_nc_model_glm_wm)

knitr::kable(Epi::ci.lin(death_nc_model_glm_wm, Exp=T))
```


```{r eh-plot-death-wm}
covariates_data_any_oc_nc_wm <- hf_any_data_oc_nc_wm

# Create new dataset with averaged values of all covariates
data_new_wm <- covariates_data_any_oc_nc_wm %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4)) %>%
  ungroup()

prediction_output_death_wm <- predict(death_nc_model_glm_wm, type = "response", data_new_wm %>% select(-death))

death_acts_preds_wm <- data_new_wm %>% cbind(prediction_output_death_wm) %>% group_by(id_time) %>% summarise(death = sum(death), total_HF = n(), pred_out_death = mean(prediction_output_death_wm)) %>% mutate(act_rate = death/total_HF)

death_acts_preds_wm %>% select(id_time, death, act_rate, pred_out_death) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) + ggplot2::geom_line(ggplot2::aes(y=pred_out_death), colour = "blue") + ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black")
```

\newpage
## LOS with HF as any diagnosis, no control
```{r eh-los-nocont, warning=FALSE, message=FALSE}


# Create a dataset of all spells with HF diagnosis in any position, just for EH,
# encode sex and non_white as dummy variables,
# set the count of number of spells to 1 for each row
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "EH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
         )

# Mixed-effects linear model: random effects for pseudoid
hf_los_nc_model_lmer <- lmer(los_dd ~ X_t + X_x + X_x_t +
                                       sexM + non_white1 +
                                       ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                       month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                       month_9 + month_10 + month_11 +
                                       (1 | pseudoid),
                                     hf_any_data_oc_nc)

summary(hf_los_nc_model_lmer)


# Display coefficients
knitr::kable(fixef(hf_los_nc_model_lmer), col.names = c("coeffs"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r eh-plot-los}
# Make a copy of the data
covariates_data_any_oc_nc <- hf_any_data_oc_nc

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc_nc %>% group_by(X_x) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

# Run model predictions on this averaged data
prediction_output_los <- predict(hf_los_nc_model_lmer, newdata = data_new %>% select(-los_dd), type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly readmission rate
los_acts_preds <- data_new %>% cbind(prediction_output_los) %>% group_by(id_time) %>% summarise(los_tot = sum(los_dd), total_HF = n(), pred_out_los = mean(prediction_output_los)) %>% mutate(act_los = los_tot/total_HF)

# Plot the chart
los_acts_preds %>% select(id_time, los_tot, act_los, pred_out_los) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_los), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_los), colour = "black")

```

\newpage
## Facet plot

```{r eh-join-data, fig.height=8, fig.width=5}
outcome_predictions_eh <- read7_acts_preds %>% rename (act_rate_7dr = act_rate) %>%
  left_join(read30_acts_preds %>% select(-total_HF) %>% rename(act_rate_30dr = act_rate),
            by = c("id_time" = "id_time")) %>%
  left_join(read90_acts_preds %>% select(-total_HF) %>% rename(act_rate_90dr = act_rate),
            by = c("id_time" = "id_time")) %>%
  left_join(death_acts_preds_wm %>% select(-total_HF) %>% rename(act_rate_death = act_rate),
            by = c("id_time" = "id_time")) %>%
  left_join(los_acts_preds %>% select(-total_HF),
            by = c("id_time" = "id_time"))

outcomes_predictions_tidy_1_eh <- outcome_predictions_eh %>% select(id_time, pred_out_7d, act_rate_7dr,
                                                            pred_out_30d, act_rate_30dr,
                                                            pred_out_90d, act_rate_90dr,
                                                            pred_out_death, act_rate_death,
                                                            pred_out_los, act_los) %>%
  gather(key = "measure", value = "outcome", -id_time) %>%
  mutate(outcome = if_else(!str_detect(measure, "los"), outcome*100, outcome))

outcomes_predictions_tidy_2_eh <- outcomes_predictions_tidy_1_eh %>% mutate(prediction = str_detect(measure, "pred"), measure_type = case_when(
  str_detect(measure, "7d") ~ "7d readmission (%)",
  str_detect(measure, "30d") ~ "30d readmission (%)",
  str_detect(measure, "90d") ~ "90d readmission (%)",
  str_detect(measure, "death") ~ "Mortality (%)",
  str_detect(measure, "los") ~ "Length of stay (days)",
)) %>%
  mutate(measure_type = factor(measure_type,
                               levels = c("7d readmission (%)", "30d readmission (%)",
                                          "90d readmission (%)", "Mortality (%)",
                                          "Length of stay (days)"))) %>%
  select(-measure) %>%
  spread(prediction, outcome) %>% rename(actual = `FALSE`, prediction = `TRUE`) %>%
  filter(!is.na(actual))


outcomes_predictions_tidy_2_eh %>% ggplot(aes(x = id_time)) + geom_point(aes(y = actual)) + geom_line(aes(y = prediction)) + facet_grid(rows = vars(measure_type), scales = "free")
```


\newpage
# Comparison NPH EH

```{r comparison, fig.height=8, fig.width=7}
outcomes_predictions_tidy_2_eh <- outcomes_predictions_tidy_2_eh %>% mutate(site = "Control Hospital")
outcomes_predictions_tidy_2 <- outcomes_predictions_tidy_2 %>% mutate(site = "Intervention Hospital")

outcome_predictions <- bind_rows(outcomes_predictions_tidy_2_eh, outcomes_predictions_tidy_2)

# Back to real time
year_month <- seq(as.Date("2012-01-01"), as.Date("2017-07-01"), by = "month")
year_month <- tibble::tibble(year_month) %>% tibble::rowid_to_column(var = "id_time") 
outcome_predictions <- outcome_predictions %>% left_join(year_month)
# Position for intervention line on plot - halfway between two months
intervention_month <- year_month %>% filter(id_time == 42) %>% pull(year_month) + 15

outcome_predictions %>% ggplot(aes(x = year_month)) +
  geom_point(aes(y = actual)) +
  geom_line(aes(y = prediction)) +
  facet_grid(rows = vars(measure_type), cols = vars(site), scales = "free_y") +
  ylim(0, NA) +
  theme(panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_vline(xintercept = intervention_month, linetype="dotted") +
  scale_x_date(breaks = seq(as.Date("2012-01-01"), as.Date("2017-07-01"), by = "6 months"),
               labels = scales::date_format("%b %Y")) +
  labs(title = "Figure 1: Interupted Time Series Analysis of Heart Failure Admission Outcomes",
       subtitle = "Time series with trends pre- and post-intervention (heart failure care bundle)",
       x = "Time (months)", y = NULL)
```



\newpage
# Combined models: intervention and control

```{r combined-dataset}
hf_any_data_oc <- hf_its_data %>% filter(wardsite %in% c("NPH", "EH"),
                                         HF_any == 1#,
                                         #X_t >= 28 # 28 is the first month with data for both sites
                                         ) %>%
  mutate(sexM = if_else(sex=="M",1,0),
         non_white1 = if_else(non_white=="1",1,0)#,
         #total_HF = 1
         )
```

## 7-day readmissions

```{r read7-all}
# Mixed-effects poisson model: random effects for pseudoid
hf_read7_all_model_glmer <- glmer(as.integer(allcausereadmission_7) ~ offset(log(total_HF)) + 
                                    X_t + X_x + X_x_t + X_z + X_z_t + X_z_x + X_z_x_t +
                                    sexM + non_white1 +
                                    ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                    month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                    month_9 + month_10 + month_11 +
                                    (1 | pseudoid),
                                  hf_any_data_oc,
                                  family = poisson(link = "log"),
                                  control=glmerControl(optimizer="bobyqa"),
                                  nAGQ = 14
                                  )

summary(hf_read7_all_model_glmer)

overdisp_fun(hf_read7_all_model_glmer)

# Display IRRs
knitr::kable(exp(fixef(hf_read7_all_model_glmer)), col.names = c("IRR"))
```

```{r read7-all-tmb}
# Mixed-effects poisson model: random effects for pseudoid
hf_read7_all_model_glmmTMB <- glmmTMB::glmmTMB(as.integer(allcausereadmission_7) ~ offset(log(total_HF)) + 
                                       X_t + X_x + X_x_t + X_z + X_z_t + X_z_x + X_z_x_t +
                                       sexM + non_white1 +
                                       ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                       month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                       month_9 + month_10 + month_11 +
                                       (1 | pseudoid),
                                     hf_any_data_oc,
                                     family = poisson(link = "log")#,
                                     #control=glmerControl(optimizer="bobyqa")
                                     )

summary(hf_read7_all_model_glmmTMB)

overdisp_fun(hf_read7_all_model_glmmTMB)

# Display IRRs
knitr::kable(exp(fixef(hf_read7_all_model_glmmTMB)$cond), col.names = c("IRR"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r plot-7read-ic}
# Make a copy of the data
covariates_data_any_oc <- hf_any_data_oc

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc %>% group_by(X_x, X_z) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()

# Run model predictions on this averaged data
prediction_output_7d <- predict(hf_read7_all_model_glmer, newdata = data_new %>% select(-allcausereadmission_7), type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly readmission rate
read7_acts_preds <- data_new %>% cbind(prediction_output_7d) %>% group_by(id_time, X_z) %>% summarise(allcausereadmission_7 = sum(allcausereadmission_7), total_HF = n(), pred_out_7d = mean(prediction_output_7d)) %>% mutate(act_rate = allcausereadmission_7/total_HF)

# Plot the chart
read7_acts_preds %>% select(id_time, X_z, allcausereadmission_7, act_rate, pred_out_7d) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_7d), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black") +
  facet_grid(rows = vars(X_z))

```

## 30-day readmissions

```{r read30-all}
# Mixed-effects poisson model: random effects for pseudoid
hf_read30_all_model_glmer <- glmer(as.integer(allcausereadmission_30) ~ offset(log(total_HF)) + 
                                       X_t + X_x + X_x_t + X_z + X_z_t + X_z_x + X_z_x_t +
                                       sexM + non_white1 +
                                       ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                       month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                       month_9 + month_10 + month_11 +
                                       (1 | pseudoid),
                                     hf_any_data_oc %>% filter(X_t <= 67 - trim_30_day),
                                     family = poisson(link = "log"),
                                     control=glmerControl(optimizer="bobyqa"))

summary(hf_read30_all_model_glmer)

overdisp_fun(hf_read30_all_model_glmer)

# Display IRRs
knitr::kable(exp(fixef(hf_read30_all_model_glmer)), col.names = c("IRR"))
```

```{r read30-all-tmb}
# Mixed-effects poisson model: random effects for pseudoid
hf_read30_all_model_glmmTMB <- glmmTMB::glmmTMB(as.integer(allcausereadmission_30) ~
                                                  offset(log(total_HF)) + 
                                                  X_t + X_x + X_x_t + X_z + X_z_t + X_z_x + X_z_x_t +
                                                  sexM + non_white1 +
                                                  ln_age + ward_2 + ward_3 + ward_4 + ward_5 +
                                                  month_1 + month_2 + month_3 + month_4 +
                                                  month_5 + month_6 + month_7 + month_8 +
                                                  month_9 + month_10 + month_11 +
                                                  (1 | pseudoid),
                                                hf_any_data_oc %>% filter(X_t <= 67 - trim_30_day),
                                                family = poisson(link = "log"),
                                                control=glmmTMB::glmmTMBControl(optCtrl =
                                                                         list(iter.max = 1e3,
                                                                              eval.max = 1e3)
                                                                       )
                                                )

summary(hf_read30_all_model_glmmTMB)

overdisp_fun(hf_read30_all_model_glmmTMB)

# Display IRRs
knitr::kable(exp(fixef(hf_read30_all_model_glmmTMB)$cond), col.names = c("IRR"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r plot-30read-ic}
# Make a copy of the data
covariates_data_any_oc <- hf_any_data_oc %>% filter(X_t <= 67 - trim_30_day)

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc %>% group_by(X_x, X_z) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()


# Run model predictions on the averaged data
prediction_output_30d <- predict(hf_read30_all_model_glmer, newdata = data_new %>% select(-allcausereadmission_30), type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly readmission rate
read30_acts_preds <- data_new %>% cbind(prediction_output_30d) %>% group_by(id_time, X_z) %>% summarise(allcausereadmission_30 = sum(allcausereadmission_30), total_HF = n(), pred_out_30d = mean(prediction_output_30d)) %>% mutate(act_rate = allcausereadmission_30/total_HF)

# Plot the chart
read30_acts_preds %>% select(id_time, X_z, allcausereadmission_30, act_rate, pred_out_30d) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_30d), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black") +
  facet_grid(rows = vars(X_z))

```

## 90-day readmissions

```{r read90-all}
# Mixed-effects poisson model: random effects for pseudoid
hf_read90_all_model_glmer <- glmer(as.integer(allcausereadmission_90) ~ offset(log(total_HF)) + 
                                       X_t + X_x + X_x_t + X_z + X_z_t + X_z_x + X_z_x_t +
                                       sexM + non_white1 +
                                       ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                       month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                       month_9 + month_10 + month_11 +
                                       (1 | pseudoid),
                                     hf_any_data_oc %>% filter(X_t <= 67 - trim_90_day),
                                     family = poisson(link = "log"),
                                     control=glmerControl(optimizer="bobyqa"))

summary(hf_read90_all_model_glmer)

overdisp_fun(hf_read90_all_model_glmer)

# Display IRRs
knitr::kable(exp(fixef(hf_read90_all_model_glmer)), col.names = c("IRR"))
```

```{r read90-all-tmb}
# Mixed-effects poisson model: random effects for pseudoid
hf_read90_all_model_glmmTMB <- glmmTMB::glmmTMB(as.integer(allcausereadmission_90) ~
                                                  offset(log(total_HF)) + 
                                                  X_t + X_x + X_x_t + X_z + X_z_t + X_z_x + X_z_x_t +
                                                  sexM + non_white1 +
                                                  ln_age + ward_2 + ward_3 + ward_4 + ward_5 +
                                                  month_1 + month_2 + month_3 + month_4 +
                                                  month_5 + month_6 + month_7 + month_8 +
                                                  month_9 + month_10 + month_11 +
                                                  (1 | pseudoid),
                                                hf_any_data_oc %>% filter(X_t <= 67 - trim_90_day),
                                                family = poisson(link = "log")#,
                                                #control=glmerControl(optimizer="bobyqa")
                                                )

summary(hf_read90_all_model_glmmTMB)

overdisp_fun(hf_read90_all_model_glmmTMB)

# Display IRRs
knitr::kable(exp(fixef(hf_read90_all_model_glmmTMB)$cond), col.names = c("IRR"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r plot-90read-ic}
# Make a copy of the data
covariates_data_any_oc <- hf_any_data_oc %>% filter(X_t <= 67 - trim_90_day)

# Create new dataset with averaged values of all covariates
data_new <- covariates_data_any_oc %>% group_by(X_x, X_z) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4),
         ward_5 = mean(ward_5)) %>%
  ungroup()


# Run model predictions on the averaged data
prediction_output_90d <- predict(hf_read90_all_model_glmer, newdata = data_new %>% select(-allcausereadmission_90), type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly readmission rate
read90_acts_preds <- data_new %>% cbind(prediction_output_90d) %>% group_by(id_time, X_z) %>% summarise(allcausereadmission_90 = sum(allcausereadmission_90), total_HF = n(), pred_out_90d = mean(prediction_output_90d)) %>% mutate(act_rate = allcausereadmission_90/total_HF)

# Plot the chart
read90_acts_preds %>% select(id_time, X_z, allcausereadmission_90, act_rate, pred_out_90d) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_90d), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black") +
  facet_grid(rows = vars(X_z))

```

\newpage
## LOS with HF as any diagnosis
```{r los, warning=FALSE, message=FALSE}
# Mixed-effects linear model: random effects for pseudoid
hf_los_model_lmer <- lmer(los_dd ~ 
                            X_t + X_x + X_x_t + X_z + X_z_t + X_z_x + X_z_x_t +
                            sexM + non_white1 +
                            ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                            month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                            month_9 + month_10 + month_11 +
                            (1 | pseudoid),
                          hf_any_data_oc)

summary(hf_los_model_lmer)


# Display coefficients
knitr::kable(fixef(hf_los_model_lmer), col.names = c("coeffs"))
```

### Plot model predictions for averaged covariates as linear trends, along with the data
```{r plot-los-ic}
# Run model predictions on the averaged data
prediction_output_los <- predict(hf_los_model_lmer, newdata = data_new %>% select(-los_dd),
                                 type = "response", allow.new.levels = TRUE, re.form=~0)

# Add the predicted outcomes as a column to the averaged dataset,
# and summarise this data by month.
# Create a new column for the actual monthly los
los_acts_preds <- data_new %>% cbind(prediction_output_los) %>% group_by(id_time, X_z) %>% summarise(los_tot = sum(los_dd), total_HF = n(), pred_out_los = mean(prediction_output_los)) %>% mutate(act_los = los_tot/total_HF)

# Plot the chart
los_acts_preds %>% select(id_time, X_z, los_tot, act_los, pred_out_los) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_los), colour = "blue") +
  ggplot2::geom_point(ggplot2::aes(y=act_los), colour = "black") +
  facet_grid(rows = vars(X_z))

```

\newpage
## Mortality, following discharge with HF as any diagnosis, with ward 5 (Other) merged with 4 (Medicine)
```{r mort-wm, warning=TRUE, message=TRUE}
hf_any_data_oc_wm <- hf_its_data %>% filter(wardsite %in% c("NPH", "EH"),
                                         HF_any == 1#,
                                         #X_t >= 28
                                         ) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0),
                #total_HF = 1,
                ward_4 = if_else(ward_5 == 1, 1L, ward_4))

death_model_glm_wm <- glm(as.integer(death) ~ offset(log(total_HF)) +
                            X_t + X_x + X_x_t + X_z + X_z_t + X_z_x + X_z_x_t +
                            sexM + non_white1 + ln_age +
                            ward_2 + ward_3 + ward_4 +
                            month_1 + month_2 + month_3 + month_4 + month_5 + month_6 +
                            month_7 + month_8 + month_9 + month_10 + month_11,
                          hf_any_data_oc_wm,
                          family = poisson(link = "log"))

summary(death_model_glm_wm)
summary(death_model_glm_wm)$dispersion
overdisp_fun(death_model_glm_wm)

knitr::kable(Epi::ci.lin(death_model_glm_wm, Exp=T))
```


```{r plot-death-wm-ic}
covariates_data_any_oc_wm <- hf_any_data_oc_wm

# Create new dataset with averaged values of all covariates
data_new_wm <- covariates_data_any_oc_wm %>% group_by(X_x, X_z) %>%
  mutate(sexM = mean(sexM), non_white1 = mean(non_white1), total_HF = mean(total_HF),
         ln_age = mean(ln_age),
         month_1 = mean(month_1), month_2 = mean(month_2), month_3 = mean(month_3),
         month_4 = mean(month_4),month_5 = mean(month_5), month_6 = mean(month_6),
         month_7 = mean(month_7), month_8 = mean(month_8), month_9 = mean(month_9),
         month_10 = mean(month_10), month_11 = mean(month_11),
         ward_2 = mean(ward_2), ward_3 = mean(ward_3), ward_4 = mean(ward_4)) %>%
  ungroup()

prediction_output_death_wm <- predict(death_model_glm_wm, type = "response", data_new_wm %>% select(-death))

death_acts_preds_wm <- data_new_wm %>% cbind(prediction_output_death_wm) %>% group_by(id_time, X_z) %>% summarise(death = sum(death), total_HF = n(), pred_out_death = mean(prediction_output_death_wm)) %>% mutate(act_rate = death/total_HF)

# Plot the chart
death_acts_preds_wm %>% select(id_time, X_z, death, act_rate, pred_out_death) %>% 
  ggplot2::ggplot(ggplot2::aes(x=id_time)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_out_death), colour = "blue") + 
  ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black") +
  facet_grid(rows = vars(X_z))
```

\newpage
# Comparison NPH EH

```{r oin-data-ic, fig.height=8, fig.width=7}
outcome_predictions_ic <- read7_acts_preds %>% ungroup() %>% rename (act_rate_7dr = act_rate) %>%
  left_join(read30_acts_preds %>% ungroup() %>% select(-total_HF) %>% rename(act_rate_30dr = act_rate),
            by = c("id_time" = "id_time", "X_z" = "X_z")) %>%
  left_join(read90_acts_preds %>% ungroup() %>% select(-total_HF) %>% rename(act_rate_90dr = act_rate),
            by = c("id_time" = "id_time", "X_z" = "X_z")) %>%
  left_join(death_acts_preds_wm %>% ungroup() %>% select(-total_HF) %>% rename(act_rate_death = act_rate),
            by = c("id_time" = "id_time", "X_z" = "X_z")) %>%
  left_join(los_acts_preds %>% ungroup() %>% select(-total_HF),
            by = c("id_time" = "id_time", "X_z" = "X_z"))

outcome_predictions_ic <- outcome_predictions_ic %>% 
  dplyr::mutate(pred_out_30d = 
                  if_else(id_time > 67 - crop_30_day, NA_real_, pred_out_30d),
                act_rate_30dr = 
                  if_else(id_time > 67 - crop_30_day, NA_real_, act_rate_30dr),
                pred_out_90d = 
                  if_else(id_time > 67 - crop_90_day, NA_real_, pred_out_90d),
                act_rate_90dr = 
                  if_else(id_time > 67 - crop_90_day, NA_real_, act_rate_90dr))

outcomes_predictions_tidy_1_ic <- outcome_predictions_ic %>% select(id_time, X_z, pred_out_7d, act_rate_7dr,
                                                            pred_out_30d, act_rate_30dr,
                                                            pred_out_90d, act_rate_90dr,
                                                            pred_out_death, act_rate_death,
                                                            pred_out_los, act_los) %>%
  gather(key = "measure", value = "outcome", -id_time, -X_z) %>%
  mutate(outcome = if_else(!str_detect(measure, "los"), outcome*100, outcome))

outcomes_predictions_tidy_2_ic <- outcomes_predictions_tidy_1_ic %>% mutate(prediction = str_detect(measure, "pred"), measure_type = case_when(
  str_detect(measure, "7d") ~ "7d readmission (%)",
  str_detect(measure, "30d") ~ "30d readmission (%)",
  str_detect(measure, "90d") ~ "90d readmission (%)",
  str_detect(measure, "death") ~ "Mortality (%)",
  str_detect(measure, "los") ~ "Length of stay (days)",
)) %>%
  mutate(measure_type = factor(measure_type,
                               levels = c("7d readmission (%)", "30d readmission (%)",
                                          "90d readmission (%)", "Mortality (%)",
                                          "Length of stay (days)"))) %>%
  select(-measure) %>%
 spread(prediction, outcome) %>% rename(actual = `FALSE`, prediction = `TRUE`) %>%
  filter(!is.na(actual)) %>%
  mutate(site = factor(if_else(X_z == 0, "Control Hospital", "Intervention Hospital")))

# Back to real time
year_month <- seq(as.Date("2012-01-01"), as.Date("2017-07-01"), by = "month")
year_month <- tibble::tibble(year_month) %>% tibble::rowid_to_column(var = "id_time") 
outcomes_predictions_tidy_2_ic <- outcomes_predictions_tidy_2_ic %>% left_join(year_month)
# Position for intervention line on plot - halfway between two months
intervention_month <- year_month %>% filter(id_time == 42) %>% pull(year_month) + 15

outcomes_predictions_tidy_2_ic %>% ggplot(aes(x = year_month)) + geom_point(aes(y = actual)) + geom_line(aes(y = prediction)) + facet_grid(rows = vars(measure_type), cols = vars(site), scales = "free") +
  ylim(0, NA) +
  theme(panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_vline(xintercept = intervention_month, linetype="dotted") +
  scale_x_date(breaks = seq(as.Date("2012-01-01"), as.Date("2017-07-01"), by = "6 months"),
               labels = scales::date_format("%b %Y")) +
  labs(title = "Figure 1: Interupted Time Series Analysis of Heart Failure Admission Outcomes",
       subtitle = "Time series with trends pre- and post-intervention (heart failure care bundle)",
       x = "Time (months)", y = NULL)
```
