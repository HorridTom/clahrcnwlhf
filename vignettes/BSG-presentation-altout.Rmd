---
title: 'Heart Failure Care Bundle: Descriptive Analysis'
author: 'null'
date: "04/09/2017"
output:
  ioslides_presentation: default
  beamer_presentation:
    toc: yes
  slidy_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

# Admissions

## NWLH Admission Patterns

```{r, echo=FALSE, results='asis', cache=TRUE}
ward_hf_types <- read.csv(file = "../data-raw/wardhftypes.csv", stringsAsFactors = FALSE)
ward_sites <- read.csv(file = "../data-raw/wardsites.csv", stringsAsFactors = FALSE)
imd_lookup <- read.csv(file = "../data-raw/imd-indices.csv", stringsAsFactors = FALSE)

emergency_spells <- clahrcnwlhf::create_new_vars(from.vignette = TRUE, ward_hf_types = ward_hf_types, ward_sites = ward_sites, imd_lookup = imd_lookup) 
emergency_spells_nph <- emergency_spells[which(emergency_spells[,"StartWardSite"] == "NPH"),]
```

`r nrow(emergency_spells)` discharges from the three hospitals between 1st January 2012 and
31st October 2016 inclusive.

```{r, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
em_sp_site <- split(emergency_spells, emergency_spells$StartWardSite)
ndisch_site <- lapply(em_sp_site, clahrcnwlhf::disch_time_table)
site_names <- names(ndisch_site)
X <- cbind(ndisch_site[[1]], ndisch_site[[2]][match(labels(ndisch_site[[1]]), labels(ndisch_site[[2]]))])
site_disch <- cbind(X, ndisch_site[[3]][match(row.names(X), labels(ndisch_site[[3]]))])
colnames(site_disch) <- site_names
matplot(site_disch[,1], type = c("b"), pch=20, col = 1, xaxt="n", ylim=c(0,6500),
        main="Total emergency discharges from NWLH by month and site")
matplot(site_disch[,2], type = c("b"), pch=19, col = 1, xaxt="n", ylim=c(0,6500), add=TRUE)
matplot(site_disch[,3], type = c("b"), pch=18, col = 1, xaxt="n", ylim=c(0,6500), add=TRUE)
axis(side=1,at=1:nrow(site_disch),labels=row.names(site_disch), las = 2, cex.axis =0.6)
legend("topright", inset=.05, legend=site_names, pch=c(20,19,18), col = 1, horiz=TRUE)
```

## NPH spells in hospital with primary diagnosis heart failure

```{r, fig.height=5, fig.width=7, cache=TRUE}
n_disch <- clahrcnwlhf::disch_time_table(emergency_spells_nph)
n_disch_hf <- clahrcnwlhf::disch_time_table(emergency_spells_nph[
  which(emergency_spells_nph[,"Heart.Failure.Episode"] == TRUE),])

matplot(n_disch_hf, type = c("b"), pch=20, col = 1, xaxt="n", ylim=c(0,100),
        main="Monthly discharges primary diagnosis Heart Failure, NPH")
axis(side=1,at=1:length(n_disch),labels=names(n_disch), las = 2, cex.axis =0.6)
```

There are a total of `r sum(n_disch_hf)` spells with primary diagnosis code
heart failure for the period. 

## Evidence of change in proportion of NPH spells with primary diagnosis heart failure

```{r, echo=FALSE, fig.height=5, fig.width=7, cache=TRUE}
library(qcc)
p_disch_hf <- n_disch_hf / n_disch
hf_proportion_data <- cbind(n_disch, n_disch_hf, p_disch_hf)
pcc1 <- qcc(data = hf_proportion_data[1:match("2015-06",rownames(hf_proportion_data)),"n_disch_hf"], sizes = hf_proportion_data[1:match("2015-06",rownames(hf_proportion_data)),"n_disch"], plot = FALSE, type = "p", newdata = hf_proportion_data[match("2015-07",rownames(hf_proportion_data)):nrow(hf_proportion_data),"n_disch_hf"], newsizes = hf_proportion_data[match("2015-07",rownames(hf_proportion_data)):nrow(hf_proportion_data),"n_disch"], chart.all = TRUE, data.name = "period before implementation")
pcc1$newdata.name <- "period after implementation"
plot(pcc1, title = "Proportion emergency spells with primary diag. heart failure", xlab = "Month", ylab = "Proportion heart failure spells", yaxt="n")
axis(2, at=pretty(c(pcc1$statistics,pcc1$newstats)), lab = paste(pretty(c(pcc1$statistics,pcc1$newstats)) * 100, "%"), las=TRUE)
```

# Care Bundle Data

## Care bundle implementation

```{r, echo=FALSE, fig.height=5, fig.width=7, cache=TRUE}
n_bundle <- clahrcnwlhf::disch_time_table(clahrcnwlhf::bundle_data_clean, discharge = FALSE,
  adm_col = "Admission.Date.Bundle")
matplot(n_bundle, type = c("b"), pch=20, col = 1, xaxt="n", ylim=c(0,150),
        main="Number of care bundles implemented per month")
axis(side=1,at=1:length(n_bundle),labels=names(n_bundle), las = 2, cex.axis =0.6)  
```

A total of `r sum(n_bundle)` bundles were completed during the period.

# Data Linkage

## Linking admissions, care bundles, and national audit data (NWLH)

```{r, echo=FALSE, fig.height=5, fig.width=7, cache=TRUE}
clahrcnwlhf::plot_linking_venn(linked_bundles = clahrcnwlhf::linked_bundle_data, linked_nicor = clahrcnwlhf::linked_nicor_data)
```

## Linking primary diagnoses of heart failure, care bundles, and national audit data (NWLH)

```{r, echo=FALSE, fig.height=5, fig.width=7, cache=TRUE}
clahrcnwlhf::plot_linking_venn(episodes = clahrcnwlhf::emergency_adms[which(clahrcnwlhf::emergency_adms$Heart.Failure.Episode == TRUE),], linked_bundles = clahrcnwlhf::linked_bundle_data, linked_nicor = clahrcnwlhf::linked_nicor_data)
```

# Northwick Park Demographics

## Ethnicity distribution (NPH spells, Primary Diag. HF)
\tiny
```{r, echo=FALSE, results='asis', cache=TRUE, warning=FALSE, message=FALSE}
library(pander, descr)
Table1 <- descr::CrossTable(emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"EthnicGroupComp"], emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"period.date"], expected = FALSE, prop.r = FALSE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE, fisher = TRUE)
Table1$RowData <- 'Ethnicity Group'
Table1$ColData <- 'Period'
pander(Table1)
pander(Table1$fisher.ts)
```

U = Black or Black British, V = Other Ethnic Groups / Not Stated, W = White, X = Mixed, Y = Asian or Asian British.

## Age distribution (NPH spells, Primary Diag. HF)
\tiny
```{r, echo=FALSE, results='asis', cache=TRUE, warning=FALSE, message=FALSE}
library(pander, descr)
library(forcats)
levels(emergency_spells_nph$AgeBand_B)[levels(emergency_spells_nph$AgeBand_B)=="young"] <- "<65"
levels(emergency_spells_nph$AgeBand_B)[levels(emergency_spells_nph$AgeBand_B)=="old"] <- ">=65"

Table1 <- descr::CrossTable(emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"AgeBand_B"], emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"period.date"], expected = FALSE, prop.r = FALSE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE, fisher = TRUE)
Table1$RowData <- 'Age Group'
Table1$ColData <- 'Period'
pander(Table1)
pander(Table1$fisher.ts)
```


## Gender distribution (NPH spells, Primary Diag. HF)
\tiny
```{r, echo=FALSE, results='asis', cache=TRUE, warning=FALSE, message=FALSE}
library(pander, descr)
Table1 <- descr::CrossTable(emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"Sex"], emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"period.date"], expected = FALSE, prop.r = FALSE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE, fisher = TRUE)
Table1$RowData <- 'Gender'
Table1$ColData <- 'Period'
pander(Table1)
pander(Table1$fisher.ts)
```

## IMD distribution (NPH spells, Primary Diag. HF)

```{r, echo=FALSE, results='asis', cache=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
imd_table <- dplyr::summarize(group_by(emergency_spells_nph,period.date),average_imd=median(IMD, na.rm = TRUE))
imd_table_HF <- dplyr::summarize(group_by(emergency_spells_nph[which(emergency_spells_nph$Heart.Failure.Episode == TRUE),],period.date),average_imd=median(IMD, na.rm = TRUE))

#knitr::kable(imd_table)
#wilcox.test(emergency_spells_nph$IMD~emergency_spells_nph$period.date)

knitr::kable(imd_table_HF)
wilcox.test(emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"IMD"]~emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"period.date"])

```

# Northwick Park Unadjusted Outcomes - Spell Level Analysis

## Mortality (NPH spells, Primary Diag. HF)
\tiny
```{r, echo=FALSE, results='asis', cache=TRUE}
Table1 <- descr::CrossTable(emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"died"], emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"period.date"], expected = FALSE, prop.r = FALSE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE)
Table1$RowData <- 'Died in hospital'
Table1$ColData <- 'Period'
pander(Table1)
pander(Table1$CST)
```

## Readmissions (NPH spells, Primary Diag. HF)
\tiny
```{r, echo=FALSE, results='asis', cache=TRUE}
em_sp_nph_r <- clahrcnwlhf::subset_by_date(emergency_spells_nph,
                                      start_date=as.Date("2012-01-01"),
                                      end_date=as.Date("2016-7-31"))

Table2 <- descr::CrossTable(em_sp_nph_r[em_sp_nph_r$Heart.Failure.Episode == TRUE,"hf.readmission.cat"], em_sp_nph_r[em_sp_nph_r$Heart.Failure.Episode == TRUE,"period.date"], expected = FALSE, prop.r = FALSE, prop.t = FALSE, prop.chisq = FALSE, chisq = TRUE, missing.include = TRUE)
Table2$RowData <- 'Readmitted'
Table2$ColData <- 'Period'
pander(Table2)
pander(Table2$CST)
```

## Length of stay (NPH spells, Primary Diag. HF)

```{r, echo=FALSE, results='asis', cache=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
emergency_spells_nph$los <- as.numeric(emergency_spells_nph$los, units = "days")

los_table <- dplyr::summarize(group_by(emergency_spells_nph,period.date),average_los=median(los, na.rm = TRUE))
los_table_HF <- dplyr::summarize(group_by(emergency_spells_nph[which(emergency_spells_nph$Heart.Failure.Episode == TRUE),],period.date),average_los=median(los, na.rm = TRUE))

knitr::kable(los_table_HF)
wilcox.test(emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"los"]~emergency_spells_nph[emergency_spells_nph$Heart.Failure.Episode == TRUE,"period.date"])

```
