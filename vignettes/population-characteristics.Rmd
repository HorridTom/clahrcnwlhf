---
title: "Population Characteristics: CLAHRC NWL Heart Failure Admission Care Bundle"
author: "Dr Thomas Woodcock"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r load_data, echo=FALSE, results='asis', cache=TRUE}
library(tidyverse)
library(knitr)
library(pander)
library(tidyverse)
library(qwraps2)
library(lubridate)
library(broom)
options(qwraps2_markup = "markdown")

ward_hf_types <- read.csv(file = "../data-raw/wardhftypes.csv", stringsAsFactors = FALSE)
ward_sites <- read.csv(file = "../data-raw/wardsites.csv", stringsAsFactors = FALSE)
imd_lookup <- read.csv(file = "../data-raw/imd-indices.csv", stringsAsFactors = FALSE)

#its_wide <- clahrcnwlhf::its_aggregate_wide(from.vignette = TRUE, ward_hf_types = ward_hf_types, ward_sites = ward_sites, imd_lookup = imd_lookup)

emergency_spells <- clahrcnwlhf::create_new_vars(from.vignette = TRUE, ward_hf_types = ward_hf_types,
                                                 ward_sites = ward_sites, imd_lookup = imd_lookup)
emergency_spells_NPHEH_disch_pre_aug17 <- emergency_spells %>%
  filter(CSPDischargeTime <= as.Date("2017-07-31"), StartWardSite %in% c('NPH', 'EH'))
emergency_spells_reduced <- clahrcnwlhf::drop_unnecessary_cols(emergency_spells_NPHEH_disch_pre_aug17)

timestamp <- gsub(":","-",paste(strsplit(x = toString(Sys.time()),split = " ")[[1]], collapse="-"))
readr::write_csv(emergency_spells_reduced, path = paste0("../data-out/clahrcnwlhf_np_eh_emerg_spells_", timestamp, ".csv"))
```

## Exclusions

Initially `r nrow(emergency_spells_reduced)` spells. `r nrow(emergency_spells_reduced %>% filter(!(StartWardSite %in% c('NPH', 'EH'))))` not from NPH or EH.
```{r exc1}
study_dataset <- emergency_spells_reduced %>% dplyr::filter(!is.na(los)) 
inc_exc <- c(nrow(study_dataset), nrow(emergency_spells_reduced) - nrow(study_dataset))
```
After removing those with missing length of stay: `r inc_exc[1]` (removed `r inc_exc[2]`).

```{r exc2}
study_dataset <- study_dataset %>% dplyr::filter(!is.na(AgeBand))
inc_exc <- c(nrow(study_dataset), inc_exc[1] - nrow(study_dataset))
```
After removing those with missing age: `r inc_exc[1]` (removed `r inc_exc[2]`).

```{r exc3}
study_dataset <- study_dataset %>% dplyr::filter(Age.est >= 20)
inc_exc <- c(nrow(study_dataset), inc_exc[1] - nrow(study_dataset))
```
After removing those in below the age of 20: `r inc_exc[1]` (removed `r inc_exc[2]`).

```{r exc4}
study_dataset <- study_dataset %>% dplyr::filter(!((Ward_hf_type %in% c('A&E', 'Ambulatory Care ', 'Community', 'Maternity') | is.na(Ward_hf_type))))
inc_exc <- c(nrow(study_dataset), inc_exc[1] - nrow(study_dataset))
```
After removing those spells at NPH discharged from ward types with no care bundles: `r inc_exc[1]` (removed `r inc_exc[2]`).

```{r exc5}
study_dataset <- study_dataset %>% dplyr::mutate(disch_day = as.Date(CSPDischargeTime)) %>%
  dplyr::distinct(PseudoID, disch_day, StartWardSite, .keep_all = TRUE)
inc_exc <- c(nrow(study_dataset), inc_exc[1] - nrow(study_dataset))
```
After removing any duplicates based on PseudoID, StartWardSite and disch_day: `r inc_exc[1]` (removed `r inc_exc[2]`).

```{r exc6}
study_dataset <- study_dataset %>% dplyr::filter(Sex %in% c('F', 'M'))
inc_exc <- c(nrow(study_dataset), inc_exc[1] - nrow(study_dataset))
```
After removing those with missing gender: `r inc_exc[1]` (removed `r inc_exc[2]`).

```{r exc7}
study_dataset <- study_dataset %>% dplyr::filter(WardSite %in% c('NPH','EH'))
inc_exc <- c(nrow(study_dataset), inc_exc[1] - nrow(study_dataset))
```
After removing those discharged from a CMH ward: `r inc_exc[1]` (removed `r inc_exc[2]`).


```{r exc8}
study_dataset <- study_dataset %>% dplyr::filter(HF.any.code == TRUE)
inc_exc <- c(nrow(study_dataset), inc_exc[1] - nrow(study_dataset))
```
After removing those without heart failure diagnosis: `r inc_exc[1]` (removed `r inc_exc[2]`).

Test for any duplicated PseudoID & CSPDischargeTime: `r !all(!duplicated(study_dataset %>% dplyr::select(PseudoID, disch_day)))`.

## Study population characteristics


```{r popnchars_prep, echo=FALSE, results='asis', cache=TRUE}
patients_first_HF_episode <- study_dataset %>% 
  group_by(PseudoID) %>% 
  slice(which.min(CSPDischargeTime)) %>% 
  ungroup()

units(patients_first_HF_episode$los) <- 'days'
```
Population: `r nrow(patients_first_HF_episode)` patients with a diagnosis of heart failure.

```{r popnchars, echo=FALSE, results='asis', cache=TRUE}
pop_summary <- list(
  "Age" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(Age.est)),
    # "min" = ~ min(Age.est, na.rm = TRUE),
    # "max" = ~ max(Age.est, na.rm = TRUE),
    "median (iqr) : band midpoints" = ~ qwraps2::median_iqr(Age.est, na_rm = TRUE)
  ),
  "Gender" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(Sex)),
    "Female" = ~ qwraps2::n_perc(Sex == "F", na_rm = TRUE, show_denom = "ifNA"),
    "Male" = ~ qwraps2::n_perc(Sex == "M", na_rm = TRUE, show_denom = "ifNA")
  ),
  "Ethnicity" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(EthnicGroupComp)),
    "Black or Black British" = ~ qwraps2::n_perc(EthnicGroupComp == "U", na_rm = TRUE, show_denom = "always"),
    "Other Ethnic Groups / Not Stated" = ~ qwraps2::n_perc(EthnicGroupComp == "V", na_rm = TRUE, show_denom = "always"),
    "White" = ~ qwraps2::n_perc(EthnicGroupComp == "W", na_rm = TRUE, show_denom = "always"),
    "Mixed" = ~ qwraps2::n_perc(EthnicGroupComp == "X", na_rm = TRUE, show_denom = "always"),
    "Asian or Asian British" = ~ qwraps2::n_perc(EthnicGroupComp == "Y", na_rm = TRUE, show_denom = "always")
  ),
  "Index of Multiple Deprivation" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(IMD)),
    # "min" = ~ min(IMD, na.rm = TRUE),
    # "max" = ~ max(IMD, na.rm = TRUE),
    "n; median (iqr)" = ~ qwraps2::median_iqr(IMD, na_rm = TRUE)#,
    #"mean (sd)" = ~ qwraps2::mean_sd(IMD,na_rm = TRUE , denote_sd = "paren")
  ),
  "Length of Stay" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(los)),
    # "min" = ~ frmt(min(los, na.rm = TRUE), digits = 2),
    # "max" = ~ frmt(max(los, na.rm = TRUE), digits = 2),
    "median (iqr)" = ~ qwraps2::median_iqr(los, na_rm = TRUE),
    "mean (sd)" = ~ qwraps2::mean_sd(los,na_rm = TRUE , denote_sd = "paren")
  ),
  "Mortality" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(died)),
    "In-hospital Mortality" = ~ qwraps2::n_perc(died, na_rm = TRUE, show_denom = "ifNA")
  ),
  # "Time to next Any-Cause Re-admission" = list(
  #   "No re-admission" = ~ qwraps2::n_perc(is.na(time.to.next.spell)),
  #   "min" = ~ min(time.to.next.spell, na.rm = TRUE),
  #   "max" = ~ max(time.to.next.spell, na.rm = TRUE),
  #   "median (iqr)" = ~ qwraps2::median_iqr(time.to.next.spell, na_rm = TRUE),
  #   "mean (sd)" = ~ qwraps2::mean_sd(time.to.next.spell, na_rm = TRUE , denote_sd = "paren")
  # ),
  "Any-Cause Re-admission Category" = list(
    "No re-admission within 90 days" = ~ qwraps2::n_perc(is.na(all.cause.readmission.cat)),
    "< 7 days" = ~ qwraps2::n_perc(all.cause.readmission.cat == '7', na_rm = TRUE, show_denom = "always"),
    ">= 7, < 30 days" = ~ qwraps2::n_perc(all.cause.readmission.cat == '30', na_rm = TRUE, show_denom = "always"),
    ">= 30, < 90 days" = ~ qwraps2::n_perc(all.cause.readmission.cat == '90', na_rm = TRUE, show_denom = "always")
  ),
  # "Time to next HF Re-admission" = list(
  #   "No re-admission" = ~ qwraps2::n_perc(is.na(time.to.next.hf.spell)),
  #   "min" = ~ min(time.to.next.hf.spell, na.rm = TRUE),
  #   "max" = ~ max(time.to.next.hf.spell, na.rm = TRUE),
  #   "median (iqr)" = ~ qwraps2::median_iqr(time.to.next.hf.spell, na_rm = TRUE),
  #   "mean (sd)" = ~ qwraps2::mean_sd(time.to.next.hf.spell, na_rm = TRUE , denote_sd = "paren")
  # ),
  "HF Re-admission Category" = list(
    "No re-admission within 90 days" = ~ qwraps2::n_perc(is.na(hf.readmission.cat)),
    "< 7 days" = ~ qwraps2::n_perc(hf.readmission.cat == '7', na_rm = TRUE, show_denom = "always"),
    ">= 7, < 30 days" = ~ qwraps2::n_perc(hf.readmission.cat == '30', na_rm = TRUE, show_denom = "always"),
    ">= 30, < 90 days" = ~ qwraps2::n_perc(hf.readmission.cat == '90', na_rm = TRUE, show_denom = "always")
  )
)

qwraps2::summary_table(patients_first_HF_episode %>% group_by(Hospital = StartWardSite, Period = period.date),
                       pop_summary)
```

#### Univariate analysis

##### Sex
Difference in difference analysis of sex

```{r sex-diffdiff}
sex_diff_in_diff_data <- patients_first_HF_episode %>% dplyr::select(StartWardSite, period.date, Sex) %>% mutate(intervention_site = StartWardSite == "NPH", intervention_period = period.date == "B", male = Sex == "M") %>% dplyr::select(intervention_site, intervention_period, male)

model <- glm(male ~. + intervention_site * intervention_period, family=binomial(link='logit'), data=sex_diff_in_diff_data)

cbind(OR = exp(coef(model)), exp(confint(model)), p = tidy(model) %>% pull(p.value))
sex_did_or <- paste(format(exp(coef(model)[4]), digits = 3), " (", format(exp(confint(model)[4,1]), digits = 3), ", ", format(exp(confint(model)[4,2]), digits = 3),")", sep = "")
sex_did_or
```

##### Age
Difference in difference analysis of age band

```{r age-diffdiff}
age_diff_in_diff_data <- patients_first_HF_episode %>% dplyr::select(StartWardSite, period.date, AgeBand) %>% mutate(intervention_site = StartWardSite == "NPH", intervention_period = period.date == "B") %>% dplyr::select(intervention_site, intervention_period, AgeBand)

# Need to collapse age bands due to small numbers in lower bands
age_diff_in_diff_data$AgeBand <- forcats::fct_collapse(age_diff_in_diff_data$AgeBand, "0 to 39" = c("0", "1 to 4", "5 to 9", "10 to 14", "15 to 19", "20 to 24", "25 to 29", "30 to 34", "35 to 39"))

model <- MASS::polr(AgeBand ~. + intervention_site * intervention_period, data=age_diff_in_diff_data, method = "logistic", Hess = TRUE)
summary(model)

exp(cbind(OR = coef(model), confint.default(model)))
age_did_or <- paste(format(exp(coef(model)[3]), digits = 3), " (", format(exp(confint.default(model)[3,1]), digits = 3), ", ", format(exp(confint.default(model)[3,2]), digits = 3),")", sep = "")
age_did_or
```

##### Ethnicity
```{r eth-diffdiff}
ethnicity_diff_in_diff_data <- patients_first_HF_episode %>% dplyr::select(StartWardSite, period.date, EthnicGroupComp) %>% mutate(intervention_site = StartWardSite == "NPH", intervention_period = period.date == "B") %>% dplyr::select(intervention_site, intervention_period, EthnicGroupComp)
# Need to collapse ethnicity categories due to small numbers
ethnicity_diff_in_diff_data$EthnicGroupComp <- forcats::fct_collapse(ethnicity_diff_in_diff_data$EthnicGroupComp, "XU" = c("X", "U"))

ethnicity_diff_in_diff_data$EthnicGroupComp <- relevel(ethnicity_diff_in_diff_data$EthnicGroupComp, ref = "W")
model <- nnet::multinom(EthnicGroupComp ~. + intervention_site * intervention_period, data=ethnicity_diff_in_diff_data)
summary(model)
exp(coef(model))
exp(confint(model))

eth_did_or_XU <- paste(format(exp(coef(model)[1,4]), digits = 3), " (", format(exp(confint(model)[4,1,1]), digits = 3), ", ", format(exp(confint(model)[4,2,1]), digits = 3),")", sep = "")
eth_did_or_XU
eth_did_or_V <- paste(format(exp(coef(model)[2,4]), digits = 3), " (", format(exp(confint(model)[4,1,2]), digits = 3), ", ", format(exp(confint(model)[4,2,2]), digits = 3),")", sep = "")
eth_did_or_V
eth_did_or_Y <- paste(format(exp(coef(model)[3,4]), digits = 3), " (", format(exp(confint(model)[4,1,3]), digits = 3), ", ", format(exp(confint(model)[4,2,3]), digits = 3),")", sep = "")
eth_did_or_Y

```

##### IMD

```{r imd-diffdiff}
imd_diff_in_diff_data <- patients_first_HF_episode %>% dplyr::select(StartWardSite, period.date, IMD) %>% mutate(intervention_site = StartWardSite == "NPH", intervention_period = period.date == "B") %>% dplyr::select(intervention_site, intervention_period, IMD)

patients_first_HF_episode %>% ggplot(aes(x = IMD)) + geom_histogram() + facet_wrap(StartWardSite ~ period.date)

model <- glm(IMD~.+ intervention_site * intervention_period, data = imd_diff_in_diff_data)

bcmod <- MASS::boxcox(model, optimise = TRUE)
bcresults <- data.frame(x = bcmod$x, y = bcmod$y)
bc_exp <- bcresults %>% arrange(-y) %>% top_n(1) %>% pull(x)
bc_model <- glm(((IMD^bc_exp - 1) / bc_exp ) ~.+ intervention_site * intervention_period, data = imd_diff_in_diff_data)

plot(fitted(bc_model), residuals(bc_model)) #qq plot also checked and fine

summary(bc_model)

cbind(Coeffs = coef(bc_model), confint(bc_model))
imd_did_or <- paste(format(coef(bc_model)[4], digits = 3), " (", format(confint(bc_model)[4,1], digits = 3), ", ", format(confint(bc_model)[4,2], digits = 3),")", sep = "")
imd_did_or
```

### Population table

```{r}
pop_table <- qwraps2::summary_table(patients_first_HF_episode %>% group_by(Hospital = StartWardSite, Period = period.date),
                       pop_summary)
```


### Study population age distribution

```{r age, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
ggplot2::ggplot(patients_first_HF_episode, ggplot2::aes(x=AgeBand))+ggplot2::geom_bar(width= 0.7) + ggplot2::labs(y = "Frequency",x = "Age Band") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1)) +
  ggplot2::facet_wrap(StartWardSite ~ period.date)

age_summary = list(
  "Age Band" = list(`0` = ~qwraps2::n_perc(AgeBand == "0", digits = 0, show_symbol = FALSE),
    `1 to 4` = ~qwraps2::n_perc(AgeBand == "1 to 4", digits = 0, show_symbol = FALSE),
    `5 to 9` = ~qwraps2::n_perc(AgeBand == "5 to 9", digits = 0, show_symbol = FALSE),
    `10 to 14` = ~qwraps2::n_perc(AgeBand == "10 to 14", digits = 0, show_symbol = FALSE),
    `15 to 19` = ~qwraps2::n_perc(AgeBand == "15 to 19", digits = 0, show_symbol = FALSE),
    `20 to 24` = ~qwraps2::n_perc(AgeBand == "20 to 24", digits = 0, show_symbol = FALSE),
    `25 to 29` = ~qwraps2::n_perc(AgeBand == "25 to 29", digits = 0, show_symbol = FALSE),
    `30 to 34` = ~qwraps2::n_perc(AgeBand == "30 to 34", digits = 0, show_symbol = FALSE),
    `35 to 39` = ~qwraps2::n_perc(AgeBand == "35 to 39", digits = 0, show_symbol = FALSE),
    `40 to 44` = ~qwraps2::n_perc(AgeBand == "40 to 44", digits = 0, show_symbol = FALSE),
    `45 to 49` = ~qwraps2::n_perc(AgeBand == "45 to 49", digits = 0, show_symbol = FALSE),
    `50 to 54` = ~qwraps2::n_perc(AgeBand == "50 to 54", digits = 0, show_symbol = FALSE),
    `55 to 59` = ~qwraps2::n_perc(AgeBand == "55 to 59", digits = 0, show_symbol = FALSE),
    `60 to 64` = ~qwraps2::n_perc(AgeBand == "60 to 64", digits = 0, show_symbol = FALSE),
    `65 to 69` = ~qwraps2::n_perc(AgeBand == "65 to 69", digits = 0, show_symbol = FALSE),
    `70 to 74` = ~qwraps2::n_perc(AgeBand == "70 to 74", digits = 0, show_symbol = FALSE),
    `75 to 79` = ~qwraps2::n_perc(AgeBand == "75 to 79", digits = 0, show_symbol = FALSE),
    `80 to 84` = ~qwraps2::n_perc(AgeBand == "80 to 84", digits = 0, show_symbol = FALSE),
    `85 to 89` = ~qwraps2::n_perc(AgeBand == "85 to 89", digits = 0, show_symbol = FALSE),
    `90 to 94` = ~qwraps2::n_perc(AgeBand == "90 to 94", digits = 0, show_symbol = FALSE),
    `95 to 99` = ~qwraps2::n_perc(AgeBand == "95 to 99", digits = 0, show_symbol = FALSE),
    `100 to 114` = ~qwraps2::n_perc(AgeBand == "100 to 114", digits = 0, show_symbol = FALSE))
)
qwraps2::summary_table(patients_first_HF_episode %>% group_by(Hospital = StartWardSite, Period = period.date),
                       age_summary)
dput(age_summary, file = '../data-out/age_summary.txt')
```

### Type of ward - study population

```{r ward, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}

ward_summary <- with(patients_first_HF_episode, qwraps2::tab_summary(Ward_hf_type))
qwraps2::summary_table(patients_first_HF_episode %>% group_by(Hospital = StartWardSite, Period = period.date),
                       list("Ward" = ward_summary))

dput(ward_summary, file = '../data-out/ward_summary.txt')
```

## Spell characteristics


```{r spchars, echo=FALSE, results='asis', cache=TRUE}
HF_spells <- study_dataset

units(HF_spells$los) <- 'days'

pop_summary <- list(
  "Age" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(Age.est)),
    #"min" = ~ min(Age.est, na.rm = TRUE),
    #"max" = ~ max(Age.est, na.rm = TRUE),
    "median (iqr) : band midpoints" = ~ qwraps2::median_iqr(Age.est, na_rm = TRUE)#,
    #"mean (sd)" = ~ qwraps2::mean_sd(Age.est,na_rm = TRUE , denote_sd = "paren")
  ),
  "Gender" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(Sex)),
    "Female" = ~ qwraps2::n_perc(Sex == "F", na_rm = TRUE, show_denom = "ifNA"),
    "Male" = ~ qwraps2::n_perc(Sex == "M", na_rm = TRUE, show_denom = "ifNA")
  ),
  "Ethnicity" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(EthnicGroupComp)),
    "Black or Black British" = ~ qwraps2::n_perc(EthnicGroupComp == "U", na_rm = TRUE, show_denom = "always"),
    "Other Ethnic Groups / Not Stated" = ~ qwraps2::n_perc(EthnicGroupComp == "V", na_rm = TRUE, show_denom = "always"),
    "White" = ~ qwraps2::n_perc(EthnicGroupComp == "W", na_rm = TRUE, show_denom = "always"),
    "Mixed" = ~ qwraps2::n_perc(EthnicGroupComp == "X", na_rm = TRUE, show_denom = "always"),
    "Asian or Asian British" = ~ qwraps2::n_perc(EthnicGroupComp == "Y", na_rm = TRUE, show_denom = "always")
  ),
  "Index of Multiple Deprivation" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(IMD)),
    #"min" = ~ min(IMD, na.rm = TRUE),
    #"max" = ~ max(IMD, na.rm = TRUE),
    "n; median (iqr)" = ~ qwraps2::median_iqr(IMD, na_rm = TRUE)#,
    #"mean (sd)" = ~ qwraps2::mean_sd(IMD,na_rm = TRUE , denote_sd = "paren")
  ),
  "Length of Stay" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(los)),
    #"min" = ~ frmt(min(los, na.rm = TRUE), digits = 2),
    #"max" = ~ frmt(max(los, na.rm = TRUE), digits = 2),
    "median (iqr)" = ~ qwraps2::median_iqr(los, na_rm = TRUE)#,
    #"mean (sd)" = ~ qwraps2::mean_sd(los,na_rm = TRUE , denote_sd = "paren")
  ),
  "Mortality" = list(
    "Missing" = ~ qwraps2::n_perc(is.na(died)),
    "In-hospital Mortality" = ~ qwraps2::n_perc(died, na_rm = TRUE, show_denom = "ifNA")
  ),
  #"Time to next Any-Cause Re-admission" = list(
    #"No re-admission" = ~ qwraps2::n_perc(is.na(time.to.next.spell)),
    #"min" = ~ min(time.to.next.spell, na.rm = TRUE),
    #"max" = ~ max(time.to.next.spell, na.rm = TRUE),
    #"median (iqr)" = ~ qwraps2::median_iqr(time.to.next.spell, na_rm = TRUE),
    #"mean (sd)" = ~ qwraps2::mean_sd(time.to.next.spell, na_rm = TRUE , denote_sd = "paren")
  #),
  "Any-Cause Re-admission Category" = list(
    "No re-admission within 90 days" = ~ qwraps2::n_perc(is.na(all.cause.readmission.cat)),
    "< 7 days" = ~ qwraps2::n_perc(all.cause.readmission.cat == '7', na_rm = TRUE, show_denom = "always"),
    ">= 7, < 30 days" = ~ qwraps2::n_perc(all.cause.readmission.cat == '30', na_rm = TRUE, show_denom = "always"),
    ">= 30, < 90 days" = ~ qwraps2::n_perc(all.cause.readmission.cat == '90', na_rm = TRUE, show_denom = "always")
  ),
  #"Time to next HF Re-admission" = list(
    #"No re-admission" = ~ qwraps2::n_perc(is.na(time.to.next.hf.spell)),
    #"min" = ~ min(time.to.next.hf.spell, na.rm = TRUE),
    #"max" = ~ max(time.to.next.hf.spell, na.rm = TRUE),
    #"median (iqr)" = ~ qwraps2::median_iqr(time.to.next.hf.spell, na_rm = TRUE),
    #"mean (sd)" = ~ qwraps2::mean_sd(time.to.next.hf.spell, na_rm = TRUE , denote_sd = "paren")
  #),
  "HF Re-admission Category" = list(
    "No re-admission within 90 days" = ~ qwraps2::n_perc(is.na(hf.readmission.cat)),
    "< 7 days" = ~ qwraps2::n_perc(hf.readmission.cat == '7', na_rm = TRUE, show_denom = "always"),
    ">= 7, < 30 days" = ~ qwraps2::n_perc(hf.readmission.cat == '30', na_rm = TRUE, show_denom = "always"),
    ">= 30, < 90 days" = ~ qwraps2::n_perc(hf.readmission.cat == '90', na_rm = TRUE, show_denom = "always")
  )
)

qwraps2::summary_table(HF_spells %>% group_by(Hospital = StartWardSite, Period = period.date),
                       pop_summary)
```

## Spell age distribution

```{r age-sp, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
ggplot2::ggplot(HF_spells, ggplot2::aes(x=AgeBand))+ggplot2::geom_bar(width= 0.7) + ggplot2::labs(y = "Frequency",x = "Age Band") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1)) +
  ggplot2::facet_wrap(StartWardSite ~ period.date)

age_summary = list(
  "Age Band" = list(`0` = ~qwraps2::n_perc(AgeBand == "0", digits = 0, show_symbol = FALSE),
    `1 to 4` = ~qwraps2::n_perc(AgeBand == "1 to 4", digits = 0, show_symbol = FALSE),
    `5 to 9` = ~qwraps2::n_perc(AgeBand == "5 to 9", digits = 0, show_symbol = FALSE),
    `10 to 14` = ~qwraps2::n_perc(AgeBand == "10 to 14", digits = 0, show_symbol = FALSE),
    `15 to 19` = ~qwraps2::n_perc(AgeBand == "15 to 19", digits = 0, show_symbol = FALSE),
    `20 to 24` = ~qwraps2::n_perc(AgeBand == "20 to 24", digits = 0, show_symbol = FALSE),
    `25 to 29` = ~qwraps2::n_perc(AgeBand == "25 to 29", digits = 0, show_symbol = FALSE),
    `30 to 34` = ~qwraps2::n_perc(AgeBand == "30 to 34", digits = 0, show_symbol = FALSE),
    `35 to 39` = ~qwraps2::n_perc(AgeBand == "35 to 39", digits = 0, show_symbol = FALSE),
    `40 to 44` = ~qwraps2::n_perc(AgeBand == "40 to 44", digits = 0, show_symbol = FALSE),
    `45 to 49` = ~qwraps2::n_perc(AgeBand == "45 to 49", digits = 0, show_symbol = FALSE),
    `50 to 54` = ~qwraps2::n_perc(AgeBand == "50 to 54", digits = 0, show_symbol = FALSE),
    `55 to 59` = ~qwraps2::n_perc(AgeBand == "55 to 59", digits = 0, show_symbol = FALSE),
    `60 to 64` = ~qwraps2::n_perc(AgeBand == "60 to 64", digits = 0, show_symbol = FALSE),
    `65 to 69` = ~qwraps2::n_perc(AgeBand == "65 to 69", digits = 0, show_symbol = FALSE),
    `70 to 74` = ~qwraps2::n_perc(AgeBand == "70 to 74", digits = 0, show_symbol = FALSE),
    `75 to 79` = ~qwraps2::n_perc(AgeBand == "75 to 79", digits = 0, show_symbol = FALSE),
    `80 to 84` = ~qwraps2::n_perc(AgeBand == "80 to 84", digits = 0, show_symbol = FALSE),
    `85 to 89` = ~qwraps2::n_perc(AgeBand == "85 to 89", digits = 0, show_symbol = FALSE),
    `90 to 94` = ~qwraps2::n_perc(AgeBand == "90 to 94", digits = 0, show_symbol = FALSE),
    `95 to 99` = ~qwraps2::n_perc(AgeBand == "95 to 99", digits = 0, show_symbol = FALSE),
    `100 to 114` = ~qwraps2::n_perc(AgeBand == "100 to 114", digits = 0, show_symbol = FALSE))
)
qwraps2::summary_table(HF_spells %>% group_by(Hospital = StartWardSite, Period = period.date),
                       age_summary)
dput(age_summary, file = '../data-out/age_sp_summary.txt')
```

## Type of ward - spells

```{r ward-sp, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}

ward_summary <- with(patients_first_HF_episode, qwraps2::tab_summary(Ward_hf_type))
qwraps2::summary_table(HF_spells %>% group_by(Hospital = StartWardSite, Period = period.date),
                       list("Ward" = ward_summary))

dput(ward_summary, file = '../data-out/ward_sp_summary.txt')
```

\newpage

## Bundles by month

```{r bundles-month, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
HF_spells %>% mutate(yearMonth = floor_date(CSPDischargeTime, 'month')) %>%
  filter(bundle == TRUE, HF.any.code == TRUE) %>%
  group_by(yearMonth) %>%
  summarize(numBundles = n()) %>%
  ggplot(mapping = aes(x = yearMonth, y = numBundles)) + geom_line() + geom_point() +
  labs(title = 'Number of Heart Failure Care Bundles Administered Each Month',
    subtitle = 'Northwick Park Hospital', ylab = 'Number of care bundles administered',
    xlab = 'Month of discharge')
```

TODO: Exclude BNP below X and with echo in prev. 3 months.

```{r bundles-compliance, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
HF_bundle_spells <- HF_spells %>% mutate(yearMonth = floor_date(CSPDischargeTime, 'month')) %>% 
  filter(bundle == TRUE, HF.any.code == TRUE) %>%
  left_join(clahrcnwlhf::linked_bundle_data %>% dplyr::select(-Admission.Datetime), by = "Bundle.Number")

# redo these graphs using ggplot properly

HF_bundle_spells %>%
  group_by(yearMonth) %>%
  mutate(BNP.Compliant1 = !(is.na(BNP.Level.Measured) | BNP.Level.Measured == "No")) %>%
  summarise(numBundles = n(), BNP_compliant1 = sum(BNP.Compliant1))  %>%
  mutate(BNP_compliance1 = BNP_compliant1/numBundles) %>%
  ggplot(mapping = aes(x = yearMonth, y = BNP_compliance1)) + geom_line() + geom_point() +
  scale_y_continuous(limits = c(0,1)) +
  labs(title = 'Percentage Compliance with BNP by Month',
    subtitle = 'Northwick Park Hospital', ylab = '% compliance',
    xlab = 'Month of discharge')

HF_bundle_spells %>%
  group_by(yearMonth) %>%
  mutate(BNP.Compliant1 = !(is.na(BNP.Level.Measured) | BNP.Level.Measured == "No")) %>%
  summarise(numBundles = n(), BNP_compliant1 = sum(BNP.Compliant1))  %>%
  mutate(BNP_compliance1 = BNP_compliant1/numBundles) %>%
  ggplot(mapping = aes(x = yearMonth, y = BNP_compliant1)) + geom_line() + geom_point() +
  labs(title = 'Number Compliant with BNP by Month',
    subtitle = 'Northwick Park Hospital', ylab = 'Number compliant',
    xlab = 'Month of discharge')

HF_bundle_spells %>%
  group_by(yearMonth) %>%
  mutate(BNP.Compliant2 = !(is.na(BNP.Level.Measured) | BNP.Level.Measured == "No" | is.na(BNP.Result))) %>%
  summarise(numBundles = n(), BNP_compliant2 = sum(BNP.Compliant2))  %>%
  mutate(BNP_compliance2 = BNP_compliant2/numBundles) %>%
  ggplot(mapping = aes(x = yearMonth, y = BNP_compliance2)) + geom_line() + geom_point() +
  scale_y_continuous(limits = c(0,1)) +
  labs(title = 'Percentage Strict Compliance with BNP by Month',
    subtitle = 'Northwick Park Hospital', ylab = '% strict compliance',
    xlab = 'Month of discharge')

HF_bundle_spells %>%
  group_by(yearMonth) %>%
  mutate(BNP.Compliant2 = !(is.na(BNP.Level.Measured) | BNP.Level.Measured == "No" | is.na(BNP.Result))) %>%
  summarise(numBundles = n(), BNP_compliant2 = sum(BNP.Compliant2))  %>%
  mutate(BNP_compliance2 = BNP_compliant2/numBundles) %>%
  ggplot(mapping = aes(x = yearMonth, y = BNP_compliant2)) + geom_line() + geom_point() +
  labs(title = 'Number Strictly Compliant with BNP by Month',
    subtitle = 'Northwick Park Hospital', ylab = 'Number strictly compliant',
    xlab = 'Month of discharge')

fix_inaccurate_dates <- function(date_approx) {
  if(is.na(date_approx)) {
    return(as_date(NA))
  } else if(!is.na(stringr::str_match(date_approx, "^[-+]?\\d*$")[1,1])) {
    return(ymd(paste(date_approx,"0101",sep = "")))
  } else if(!is.na(stringr::str_match(date_approx, "-")[1,1])) {
    return(myd(paste(date_approx,"-01", sep = "")))
  } else return(dmy(date_approx))
}

fix_inacc_dts_v <- Vectorize(fix_inaccurate_dates)

HF_bundle_spells <- HF_bundle_spells  %>% mutate(Date.of.last.echo = 
                                                   if_else(Date.of.last.echo == "NA " |
                                                             Date.of.last.echo == " NA" |
                                                             Date.of.last.echo == "N/A",
                                                           NA_character_, Date.of.last.echo)) %>%
  rowwise() %>%
  mutate(date_last_echo = fix_inaccurate_dates(Date.of.last.echo)) %>%
  ungroup() %>%
  mutate(time_since_last_echo = difftime(CSPAdmissionTime, date_last_echo, units = "days")) %>%
  mutate(echo_completed_dt = as.POSIXct(Date.completed + hm(Time.completed)),
         time_to_echo = difftime(echo_completed_dt, CSPAdmissionTime, units = "hours")) %>%
  mutate(echo_compliant = (time_since_last_echo <= 182) | (time_to_echo <= 48 & time_to_echo > -182*24),
         echo_compliant = if_else(is.na(echo_compliant), FALSE, echo_compliant))

HF_bundle_spells %>%
  group_by(yearMonth) %>%
  summarise(numBundles = n(), echo_compliant = sum(echo_compliant))  %>%
  mutate(echo_compliance = echo_compliant/numBundles) %>%
  ggplot(mapping = aes(x = yearMonth, y = echo_compliance)) + geom_line() + geom_point() +
  scale_y_continuous(limits = c(0,1)) +
  labs(title = 'Percentage Compliance with Echo by Month',
    subtitle = 'Northwick Park Hospital', ylab = '% compliance',
    xlab = 'Month of discharge')

HF_bundle_spells %>%
  group_by(yearMonth) %>%
  summarise(numBundles = n(), echo_compliant = sum(echo_compliant))  %>%
  mutate(echo_compliance = echo_compliant/numBundles) %>%
  ggplot(mapping = aes(x = yearMonth, y = echo_compliant)) + geom_line() + geom_point() +
  labs(title = 'Number Compliant with Echo by Month',
    subtitle = 'Northwick Park Hospital', ylab = 'Number Compliant',
    xlab = 'Month of discharge')

HF_bundle_spells <- HF_bundle_spells %>% mutate(Specialist.Referral.Made = tolower(Specialist.Referral.Made),
                                                referral_compliant = if_else(is.na(Specialist.Referral.Made) |
                                                                                Specialist.Referral.Made == "no",
                                                                              FALSE, TRUE))

HF_bundle_spells %>%
  group_by(yearMonth) %>%
  summarise(numBundles = n(), referral_compliant = sum(referral_compliant))  %>%
  mutate(referral_compliance = referral_compliant/numBundles) %>%
  ggplot(mapping = aes(x = yearMonth, y = referral_compliance)) + geom_line() + geom_point() +
  scale_y_continuous(limits = c(0,1)) +
  labs(title = 'Percentage Compliance with Specialist Referral by Month',
    subtitle = 'Northwick Park Hospital', ylab = '% compliance',
    xlab = 'Month of discharge')

HF_bundle_spells %>%
  group_by(yearMonth) %>%
  summarise(numBundles = n(), referral_compliant = sum(referral_compliant))  %>%
  mutate(referral_compliance = referral_compliant/numBundles) %>%
  ggplot(mapping = aes(x = yearMonth, y = referral_compliant)) + geom_line() + geom_point() +
  labs(title = 'Number Compliant with Specialist Referral by Month',
    subtitle = 'Northwick Park Hospital', ylab = 'Number compliant',
    xlab = 'Month of discharge')
```
Probably need to split echo compliance into those who'd had one <6months and those having new one within 48h.

## Outcomes

### Mortality

```{r mortality-chart, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
HF_spells %>% mutate(yearMonth = floor_date(CSPDischargeTime, 'month')) %>%
  filter(HF.any.code == TRUE, yearMonth > as.Date("2014-04-01")) %>%
  group_by(yearMonth, StartWardSite) %>%
  summarize(numDischarged = n(), numDeaths = sum(died)) %>%
  mutate(mortality_rate = numDeaths/numDischarged) %>%
  ggplot(mapping = aes(x = yearMonth, y = mortality_rate, colour = StartWardSite)) + geom_line() + geom_point() +
  labs(title = 'Monthly Raw Mortality Rate',
    subtitle = 'LNW', ylab = 'Mortality Rate',
    xlab = 'Month of discharge') + scale_y_continuous(limits = c(0,NA))
```

### Length of Stay

```{r los-chart, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
units(HF_spells$los) <- 'days'

HF_spells %>% mutate(yearMonth = floor_date(CSPDischargeTime, 'month')) %>%
  filter(HF.any.code == TRUE, yearMonth > as.Date("2014-04-01")) %>%
  group_by(yearMonth, StartWardSite) %>%
  summarize(av_los = mean(los, na.rm = TRUE)) %>%
  ggplot(mapping = aes(x = yearMonth, y = av_los, colour = StartWardSite)) + geom_line() + geom_point() +
  labs(title = 'Monthly Average Length of Stay',
    subtitle = 'LNW', ylab = 'Average Length of Stay',
    xlab = 'Month of discharge') + scale_y_continuous(limits = c(0,NA))
```

### Readmissions

```{r readms-chart-7ac, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
HF_spells %>% mutate(yearMonth = floor_date(CSPDischargeTime, 'month')) %>%
  filter(HF.any.code == TRUE, yearMonth >= as.Date("2014-04-01"), yearMonth <= as.Date("2017-06-30")) %>%
  group_by(yearMonth, StartWardSite) %>%
  summarize(numDischarged = n(), numReadm = sum(all.cause.readmission.cat == "7", na.rm = TRUE)) %>%
  mutate(readmission_rate = numReadm/numDischarged) %>%
  ggplot(mapping = aes(x = yearMonth, y = readmission_rate, colour = StartWardSite)) + geom_line() + geom_point() +
  labs(title = 'Monthly 7-day All-Cause Readmission Rate',
    subtitle = 'LNW', ylab = 'Readmission Rate',
    xlab = 'Month of discharge') + scale_y_continuous(limits = c(0,.25))
```

```{r readms-chart-30ac, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
HF_spells %>% mutate(yearMonth = floor_date(CSPDischargeTime, 'month')) %>%
  filter(HF.any.code == TRUE, yearMonth >= as.Date("2014-04-01"), yearMonth <= as.Date("2017-05-30")) %>%
  group_by(yearMonth, StartWardSite) %>%
  summarize(numDischarged = n(), numReadm = sum(all.cause.readmission.cat == "30", na.rm = TRUE)) %>%
  mutate(readmission_rate = numReadm/numDischarged) %>%
  ggplot(mapping = aes(x = yearMonth, y = readmission_rate, colour = StartWardSite)) + geom_line() + geom_point() +
  labs(title = 'Monthly 8- to 30-day All-Cause Readmission Rate',
    subtitle = 'LNW', ylab = 'Readmission Rate',
    xlab = 'Month of discharge') + scale_y_continuous(limits = c(0,.25))
```   
```{r readms-chart-90ac, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
HF_spells %>% mutate(yearMonth = floor_date(CSPDischargeTime, 'month')) %>%
  filter(HF.any.code == TRUE, yearMonth >= as.Date("2014-04-01"), yearMonth <= as.Date("2017-03-30")) %>%
  group_by(yearMonth, StartWardSite) %>%
  summarize(numDischarged = n(), numReadm = sum(all.cause.readmission.cat == "90", na.rm = TRUE)) %>%
  mutate(readmission_rate = numReadm/numDischarged) %>%
  ggplot(mapping = aes(x = yearMonth, y = readmission_rate, colour = StartWardSite)) + geom_line() + geom_point() +
  labs(title = 'Monthly 31- to 90-day All-Cause Readmission Rate',
    subtitle = 'LNW', ylab = 'Readmission Rate',
    xlab = 'Month of discharge') + scale_y_continuous(limits = c(0,.25))
```

```{r readms-chart-7hf, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
HF_spells %>% mutate(yearMonth = floor_date(CSPDischargeTime, 'month')) %>%
  filter(HF.any.code == TRUE, yearMonth >= as.Date("2014-04-01"), yearMonth <= as.Date("2017-06-30")) %>%
  group_by(yearMonth, StartWardSite) %>%
  summarize(numDischarged = n(), numReadm = sum(hf.readmission.cat == "7", na.rm = TRUE)) %>%
  mutate(readmission_rate = numReadm/numDischarged) %>%
  ggplot(mapping = aes(x = yearMonth, y = readmission_rate, colour = StartWardSite)) + geom_line() + geom_point() +
  labs(title = 'Monthly 7-day Heart Failure Specific Readmission Rate',
    subtitle = 'LNW', ylab = 'Readmission Rate',
    xlab = 'Month of discharge') + scale_y_continuous(limits = c(0,0.05))
```

```{r readms-chart-30hf, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
HF_spells %>% mutate(yearMonth = floor_date(CSPDischargeTime, 'month')) %>%
  filter(HF.any.code == TRUE, yearMonth >= as.Date("2014-04-01"), yearMonth <= as.Date("2017-05-30")) %>%
  group_by(yearMonth, StartWardSite) %>%
  summarize(numDischarged = n(), numReadm = sum(hf.readmission.cat == "30", na.rm = TRUE)) %>%
  mutate(readmission_rate = numReadm/numDischarged) %>%
  ggplot(mapping = aes(x = yearMonth, y = readmission_rate, colour = StartWardSite)) + geom_line() + geom_point() +
  labs(title = 'Monthly 8- to 30-day Heart Failure Specific Readmission Rate',
    subtitle = 'LNW', ylab = 'Readmission Rate',
    xlab = 'Month of discharge') + scale_y_continuous(limits = c(0,0.05))
```   
```{r readms-chart-90hf, echo=FALSE, results='asis', fig.height=5, fig.width=7, cache=TRUE}
HF_spells %>% mutate(yearMonth = floor_date(CSPDischargeTime, 'month')) %>%
  filter(HF.any.code == TRUE, yearMonth >= as.Date("2014-04-01"), yearMonth <= as.Date("2017-03-30")) %>%
  group_by(yearMonth, StartWardSite) %>%
  summarize(numDischarged = n(), numReadm = sum(hf.readmission.cat == "90", na.rm = TRUE)) %>%
  mutate(readmission_rate = numReadm/numDischarged) %>%
  ggplot(mapping = aes(x = yearMonth, y = readmission_rate, colour = StartWardSite)) + geom_line() + geom_point() +
  labs(title = 'Monthly 31- to 90-day Heart Failure Specific Readmission Rate',
    subtitle = 'LNW', ylab = 'Readmission Rate',
    xlab = 'Month of discharge') + scale_y_continuous(limits = c(0,0.05))
```
