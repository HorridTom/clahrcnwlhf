---
title: "Spline Interrupted Time Series Analysis"
author: "Tom Woodcock"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

Package repo commit: `r stringr::str_sub(system("git rev-parse HEAD", intern=TRUE), 1, 8)`

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  dev = c("png", "tiff"),
  dev.args = list(tiff = list(compression="lzw")),
  dpi = 300,
  fig.path = "splines_ITS_Images/",
  crop = NULL
)
```

```{r dependencies}
library(magrittr)
library(pglm)
library(lme4)
library(splines2)
library(tidyverse)
library(lmerTest)
library(effects)
library(multcomp)
```

```{r source}
source(file.path("..", "R", "spline_helpers.R"))
source(file.path("..", "R", "regression_helpers.R"))
```

``` {r trims}
trim_readmission_analysis = TRUE
crop_readmission_analysis = TRUE
if(trim_readmission_analysis) {
  trim_30_day <- 1
  trim_90_day <- 3
} else {
  trim_30_day <- 0
  trim_90_day <- 0
}
if(crop_readmission_analysis) {
  crop_30_day <- 1
  crop_90_day <- 3
} else {
  crop_30_day <- 0
  crop_90_day <- 0
}

```



```{r load-data}
load("../data-raw/hf_its_data.rda")

# Select only those variables needed for the analysis
hf_its_data <- hf_its_data %>% dplyr::select(X_t, X_x, X_x_t, X_z, X_z_t, X_z_x, X_z_x_t,
                                             pseudoid, HF_primary, HF_any, sex, non_white,
                                             ln_age, ward_2, ward_3, ward_4, ward_5,
                                             starts_with("month_"), -month_12,
                                             hospital, imd_q,
                                             starts_with("allcausereadmission_"),
                                             starts_with("hfreadmission_"), death,
                                             los_dd, total_HF, wardsite, id_time, count)

# Convert sex and non_white variables to factors
hf_its_data <- hf_its_data %>% mutate(sex = factor(sex),
                                             non_white = factor(non_white))
```

id_time = 43 or equivalently X_t = 43 is the first point in the intervention
period, i.e. the first point where X_x = 1.

```{r sense-check, include=FALSE}
hf_its_data <- hf_its_data %>% filter(wardsite != "CMH")

table(hf_its_data$id_time >= 43, hf_its_data$X_x , useNA = "always")

table(hf_its_data$id_time > 43, hf_its_data$X_x_t , useNA = "always")

table(hf_its_data$wardsite, hf_its_data$X_z , useNA = "always")

table(hf_its_data$id_time >= 43, hf_its_data$X_z_t , useNA = "always")

table(hf_its_data$id_time >= 43, hf_its_data$X_z_x , useNA = "always")

table(hf_its_data$id_time >= 43, hf_its_data$X_z_x_t , useNA = "always")

```


# Northwick Park Outcomes

## 7-day all cause readmission rate, following discharge with HF as any diagnosis, no control
```{r data_prep, warning=FALSE, message=FALSE}


# Create a dataset of all spells with HF diagnosis in any position, just for NPH,
# encode sex and non_white as dummy variables,
# set the count of number of spells to 1 for each row
hf_any_data_oc_nc <- hf_its_data %>% filter(wardsite == "NPH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
         )

hf_any_data_oc_nc <- hf_any_data_oc_nc %>% 
  mutate(across(c(X_t, X_x, X_x_t, X_z, X_z_t, X_z_x, X_z_x_t,
                  sexM, non_white1, ln_age, ward_2, ward_3, ward_4, ward_5,
                  month_1, month_2, month_3, month_4, month_5, month_6, month_7,
                  month_8, month_9, month_10, month_11),
                ~ c(scale(.x, scale = FALSE)))) %>%
  mutate(Xxt2 = X_x_t, Xzt2 = X_z_t, Xzx2 = X_z_x, Xzxt2 = X_z_x_t,
         X_x_t = X_t * X_x,
         X_z_t = X_t * X_z,
         X_z_x = X_x * X_z,
         X_z_x_t = X_t * X_x * X_z)



```

```{r}
# Centering X_t shifts by -38.93738
intervention_X_t <- 43 - 38.93738 - 0.5 # corresponds with original X_t = id_time = 42.5

table(hf_any_data_oc_nc$X_t >= intervention_X_t, hf_any_data_oc_nc$X_x , useNA = "always")
```

```{r fit-spline-model}
hf_read7_all_nc_model_glmer_spline <- glmer(allcausereadmission_7 ~ offset(log(total_HF)) +
                                              splines2::bSpline(X_t,
                                                          knots = c(3.56262),
                                                          degree = 1) + 
                                              sexM + non_white1 +
                                              ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                              month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                              month_9 + month_10 + month_11 +
                                              (1 | pseudoid),
                                            data = hf_any_data_oc_nc,
                                            family = poisson(link = "log"),
                                            control = glmerControl(optimizer="bobyqa")
)


summary(hf_read7_all_nc_model_glmer_spline)
```


```{r plot-7read-splines}
read7_outputs <- plot_its(hf_read7_all_nc_model_glmer_spline,
                          hf_any_data_oc_nc,
                          all_preds = TRUE)

read7_acts_preds <- read7_outputs$acts_preds

read7_outputs$plt
```

```{r}
spline_basis_read7 <- splines2::bSpline(hf_any_data_oc_nc$X_t,
                                        knots = c(3.56262),
                                        degree = 1)
```

```{r}
xt_vals <- hf_any_data_oc_nc %>% distinct(X_t) %>% arrange(X_t) %>% mutate(x = row_number())

bsfns <- get_spline_eqns(spline_basis_read7,
                         x_vals = xt_vals)

# We can also get the y = alpha + beta * x form of the linear predictor in
# each of the two regions (left and right of the knot)

coefs <-fixef(hf_read7_all_nc_model_glmer_spline)
names(coefs) <- NULL

alpha <- coefs[1]
beta1 <- coefs[2]
beta2 <- coefs[3]

# Check from here.

lp <- expand_one_knot_spline_linear_predictor(beta1 = beta1,
                                        beta2 = beta2,
                                        alpha = alpha,
                                        basis_functions = bsfns,
                                        intercept = TRUE)

lp
```
```{r}
K <- get_linear_combination_for_difference_in_log_rr(spline_basis_read7, xt_vals)

K <- ramify::resize(K, nrow = 1L, ncol = length(coefs))

K[,4:length(coefs)] <- 0

K
```

```{r}
### set up general linear hypothesis
glht_logslopediff <- glht(hf_read7_all_nc_model_glmer_spline, linfct = K)
summary(glht_logslopediff)

glht_logslopediff_ci <- confint(glht_logslopediff)
glht_logslopediff_ci

confint_read7_i <- exp(glht_logslopediff_ci$confint)

pval_read7_i <- summary(glht_logslopediff)$test$pvalues[1]
results <- as_tibble(confint_read7_i)
results <- results %>% mutate(outcome = "7d readmission", site = "Intervention", pvalue = pval_read7_i)

results
```


## 30-day all cause readmission rate, following discharge with HF as any diagnosis, no control

```{r fit-spline-model-30}

hf_read30_all_nc_model_glmer_spline <- glmer(allcausereadmission_30 ~ offset(log(total_HF)) +
                                              splines2::bSpline(X_t,
                                                          knots = c(3.56262),
                                                          degree = 1) + 
                                              sexM + non_white1 +
                                              ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                              month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                              month_9 + month_10 + month_11 +
                                              (1 | pseudoid),
                                            data = hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_30_day),
                                            family = poisson(link = "log"),
                                            control = glmerControl(optimizer="bobyqa")
)


summary(hf_read30_all_nc_model_glmer_spline)
```


```{r plot-30read-splines}
read30_outputs <- plot_its(hf_read30_all_nc_model_glmer_spline,
                           hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_30_day),
                           add_term = TRUE,
                           all_preds = TRUE)

read30_acts_preds <- read30_outputs$acts_preds

read30_outputs$plt
```

```{r}
spline_basis_read30 <- splines2::bSpline(hf_any_data_oc_nc$X_t,
                                        knots = c(3.56262),
                                        degree = 1)
```

```{r}
xt_vals <- hf_any_data_oc_nc %>% distinct(X_t) %>% arrange(X_t) %>% mutate(x = row_number())

bsfns <- get_spline_eqns(spline_basis_read30,
                         x_vals = xt_vals)

# We can also get the y = alpha + beta * x form of the linear predictor in
# each of the two regions (left and right of the knot)

coefs <-fixef(hf_read30_all_nc_model_glmer_spline)
names(coefs) <- NULL

alpha <- coefs[1]
beta1 <- coefs[2]
beta2 <- coefs[3]

# Check from here.

lp <- expand_one_knot_spline_linear_predictor(beta1 = beta1,
                                        beta2 = beta2,
                                        alpha = alpha,
                                        basis_functions = bsfns,
                                        intercept = TRUE)

lp
```
```{r}
K <- get_linear_combination_for_difference_in_log_rr(spline_basis_read30, xt_vals)

K <- ramify::resize(K, nrow = 1L, ncol = length(coefs))

K[,4:length(coefs)] <- 0

K
```

```{r}
### set up general linear hypothesis
glht_logslopediff <- glht(hf_read30_all_nc_model_glmer_spline, linfct = K)
summary(glht_logslopediff)

glht_logslopediff_ci <- confint(glht_logslopediff)
glht_logslopediff_ci

confint_read30_i <- exp(glht_logslopediff_ci$confint)

pval_read30_i <- summary(glht_logslopediff)$test$pvalues[1]
results <- results %>% bind_rows(as_tibble(confint_read30_i))

results[nrow(results), "outcome"] <- "30d readmission"
results[nrow(results), "site"] <- "Intervention"
results[nrow(results), "pvalue"] <- pval_read30_i

results
```

## 90-day all cause readmission rate, following discharge with HF as any diagnosis, no control

```{r fit-spline-model-90}

hf_read90_all_nc_model_glmer_spline <- glmer(allcausereadmission_90 ~ offset(log(total_HF)) +
                                              splines2::bSpline(X_t,
                                                          knots = c(3.56262),
                                                          degree = 1) + 
                                              sexM + non_white1 +
                                              ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                              month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                              month_9 + month_10 + month_11 +
                                              (1 | pseudoid),
                                            data = hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_90_day),
                                            family = poisson(link = "log"),
                                            control = glmerControl(optimizer="bobyqa")
)


summary(hf_read90_all_nc_model_glmer_spline)
```


```{r plot-90read-splines}
read90_outputs <- plot_its(hf_read90_all_nc_model_glmer_spline,
                           hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_90_day),
                           add_term = TRUE,
                           all_preds = TRUE)


read90_acts_preds <- read90_outputs$acts_preds

read90_outputs$plt
```

```{r}
spline_basis_read90 <- splines2::bSpline(hf_any_data_oc_nc$X_t,
                                        knots = c(3.56262),
                                        degree = 1)
```

```{r}
xt_vals <- hf_any_data_oc_nc %>% distinct(X_t) %>% arrange(X_t) %>% mutate(x = row_number())

bsfns <- get_spline_eqns(spline_basis_read90,
                         x_vals = xt_vals)

# We can also get the y = alpha + beta * x form of the linear predictor in
# each of the two regions (left and right of the knot)

coefs <-fixef(hf_read90_all_nc_model_glmer_spline)
names(coefs) <- NULL

alpha <- coefs[1]
beta1 <- coefs[2]
beta2 <- coefs[3]

# Check from here.

lp <- expand_one_knot_spline_linear_predictor(beta1 = beta1,
                                        beta2 = beta2,
                                        alpha = alpha,
                                        basis_functions = bsfns,
                                        intercept = TRUE)

lp
```
```{r}
K <- get_linear_combination_for_difference_in_log_rr(spline_basis_read90, xt_vals)

K <- ramify::resize(K, nrow = 1L, ncol = length(coefs))

K[,4:length(coefs)] <- 0

K
```

```{r}
### set up general linear hypothesis
glht_logslopediff <- glht(hf_read90_all_nc_model_glmer_spline, linfct = K)
summary(glht_logslopediff)

glht_logslopediff_ci <- confint(glht_logslopediff)
glht_logslopediff_ci

confint_read90_i <- exp(glht_logslopediff_ci$confint)

pval_read90_i <- summary(glht_logslopediff)$test$pvalues[1]
results <- results %>% bind_rows(as_tibble(confint_read90_i))

results[nrow(results), "outcome"] <- "90d readmission"
results[nrow(results), "site"] <- "Intervention"
results[nrow(results), "pvalue"] <- pval_read90_i

results
```

## Mortality

```{r mort-wm-oc, warning=TRUE, message=TRUE}
hf_any_data_oc_wm <- hf_any_data_oc_nc %>%
  mutate(ward_4 = if_else(ward_5 == max(ward_5), max(ward_4), ward_4))

death_model_glm_wm_spline <- glm(as.integer(death) ~ offset(log(total_HF)) +
                            splines2::bSpline(X_t,
                                              knots = c(3.56262),
                                              degree = 1)
                          +
                            sexM + non_white1 + ln_age +
                            ward_2 + ward_3 + ward_4 +
                            month_1 + month_2 + month_3 + month_4 + month_5 + month_6 +
                            month_7 + month_8 + month_9 + month_10 + month_11,
                          hf_any_data_oc_wm,
                          family = poisson(link = "log"))

summary(death_model_glm_wm_spline)
summary(death_model_glm_wm_spline)$dispersion
overdisp_fun(death_model_glm_wm_spline)

knitr::kable(Epi::ci.lin(death_model_glm_wm_spline, Exp=T))
```


```{r plot-death-splines}
death_outputs <- plot_its(death_model_glm_wm_spline,
                          hf_any_data_oc_nc %>% filter(X_t <= 67 - trim_90_day),
                          add_term = FALSE,
                          all_preds = TRUE)


death_acts_preds <- death_outputs$acts_preds

death_outputs$plt
```

```{r}
spline_basis_death <- splines2::bSpline(hf_any_data_oc_wm$X_t,
                                        knots = c(3.56262),
                                        degree = 1)
```

```{r}
xt_vals <- hf_any_data_oc_wm %>% distinct(X_t) %>% arrange(X_t) %>% mutate(x = row_number())

bsfns <- get_spline_eqns(spline_basis_death,
                         x_vals = xt_vals)

# We can also get the y = alpha + beta * x form of the linear predictor in
# each of the two regions (left and right of the knot)

coefs <- coefficients(death_model_glm_wm_spline)
names(coefs) <- NULL

alpha <- coefs[1]
beta1 <- coefs[2]
beta2 <- coefs[3]

# Check from here.

lp <- expand_one_knot_spline_linear_predictor(beta1 = beta1,
                                        beta2 = beta2,
                                        alpha = alpha,
                                        basis_functions = bsfns,
                                        intercept = TRUE)

lp
```
```{r}
K <- get_linear_combination_for_difference_in_log_rr(spline_basis_death, xt_vals)

K <- ramify::resize(K, nrow = 1L, ncol = length(coefs))

K[,4:length(coefs)] <- 0

K
```

```{r}
### set up general linear hypothesis
glht_logslopediff <- glht(death_model_glm_wm_spline, linfct = K)
summary(glht_logslopediff)

glht_logslopediff_ci <- confint(glht_logslopediff)
glht_logslopediff_ci

confint_death_i <- exp(glht_logslopediff_ci$confint)

pval_death_i <- summary(glht_logslopediff)$test$pvalues[1]
results <- results %>% bind_rows(as_tibble(confint_death_i))

results[nrow(results), "outcome"] <- "Mortality"
results[nrow(results), "site"] <- "Intervention"
results[nrow(results), "pvalue"] <- pval_death_i

results
```



## Loglos
```{r los-log, warning=FALSE, message=FALSE}
hf_any_data_oc_nc_ll <- hf_any_data_oc_nc %>%
  mutate(los_dd = log(los_dd))

# Mixed-effects linear model: random effects for pseudoid
hf_los_log_model_lmer_spline <- lmer(los_dd ~ splines2::bSpline(X_t,
                                                                knots = c(3.56262),
                                                                degree = 1) +
                                       sexM + non_white1 +
                                       ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                       month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                       month_9 + month_10 + month_11 +
                                       (1 | pseudoid),
                                     hf_any_data_oc_nc_ll)

summary(hf_los_log_model_lmer_spline)


# Display coefficients
#knitr::kable(fixef(hf_los_log_model_lmer), col.names = c("coeffs"))
knitr::kable(exp(fixef(hf_los_log_model_lmer_spline)), col.names = c("exp_coeffs"))
```


```{r plot-los-splines}
los_outputs <- plot_its(hf_los_log_model_lmer_spline,
                        hf_any_data_oc_nc %>%
                          mutate(los_dd = log(los_dd)),
                        add_term = FALSE,
                        all_preds = TRUE,
                        los_model = TRUE)


los_acts_preds <- los_outputs$acts_preds

los_outputs$plt
```


```{r}
spline_basis_los <- splines2::bSpline(hf_any_data_oc_nc_ll$X_t,
                                        knots = c(3.56262),
                                        degree = 1)
```

```{r}
xt_vals <- hf_any_data_oc_nc_ll %>% distinct(X_t) %>% arrange(X_t) %>% mutate(x = row_number())

bsfns <- get_spline_eqns(spline_basis_los,
                         x_vals = xt_vals)

# We can also get the y = alpha + beta * x form of the linear predictor in
# each of the two regions (left and right of the knot)

coefs <-fixef(hf_los_log_model_lmer_spline)
names(coefs) <- NULL

alpha <- coefs[1]
beta1 <- coefs[2]
beta2 <- coefs[3]

# Check from here.

lp <- expand_one_knot_spline_linear_predictor(beta1 = beta1,
                                        beta2 = beta2,
                                        alpha = alpha,
                                        basis_functions = bsfns,
                                        intercept = TRUE)

lp
```
```{r}
K <- get_linear_combination_for_difference_in_log_rr(spline_basis_los, xt_vals)

K <- ramify::resize(K, nrow = 1L, ncol = length(coefs))

K[,4:length(coefs)] <- 0

K
```

```{r}
### set up general linear hypothesis
glht_logslopediff <- glht(hf_los_log_model_lmer_spline, linfct = K)
summary(glht_logslopediff)

glht_logslopediff_ci <- confint(glht_logslopediff)
glht_logslopediff_ci

confint_los_i <- exp(glht_logslopediff_ci$confint)

pval_los_i <- summary(glht_logslopediff)$test$pvalues[1]
results <- results %>% bind_rows(as_tibble(confint_los_i))

results[nrow(results), "outcome"] <- "Length of stay"
results[nrow(results), "site"] <- "Intervention"
results[nrow(results), "pvalue"] <- pval_los_i

results
```
















# Ealing - Control

## 7-day all cause readmission rate, following discharge with HF as any diagnosis,  control
```{r data_prep-c, warning=FALSE, message=FALSE}


# Create a dataset of all spells with HF diagnosis in any position, just for NPH,
# encode sex and non_white as dummy variables,
# set the count of number of spells to 1 for each row
hf_any_data_oc_c <- hf_its_data %>% filter(wardsite == "EH", HF_any == 1) %>%
  mutate(sexM = if_else(sex=="M",1,0),
                non_white1 = if_else(non_white=="1",1,0)#,
                #total_HF = 1
         )

hf_any_data_oc_c <- hf_any_data_oc_c %>% 
  mutate(across(c(X_t, X_x, X_x_t, X_z, X_z_t, X_z_x, X_z_x_t,
                  sexM, non_white1, ln_age, ward_2, ward_3, ward_4, ward_5,
                  month_1, month_2, month_3, month_4, month_5, month_6, month_7,
                  month_8, month_9, month_10, month_11),
                ~ c(scale(.x, scale = FALSE)))) %>%
  mutate(Xxt2 = X_x_t, Xzt2 = X_z_t, Xzx2 = X_z_x, Xzxt2 = X_z_x_t,
         X_x_t = X_t * X_x,
         X_z_t = X_t * X_z,
         X_z_x = X_x * X_z,
         X_z_x_t = X_t * X_x * X_z)



```

```{r}
# Centering X_t shifts by 20.73428 + 28
intervention_X_t <- 43 - (20.73428 + 28) + 0.5 # corresponds with original X_t = id_time = 42.5

table(hf_any_data_oc_c$X_t >= intervention_X_t, hf_any_data_oc_c$X_x , useNA = "always")
```

```{r fit-spline-model-read7-c}
hf_read7_all_c_model_glmer_spline <- glmer(allcausereadmission_7 ~ offset(log(total_HF)) +
                                              splines2::bSpline(X_t,
                                                          knots = c(-6.23428),
                                                          degree = 1) + 
                                              sexM + non_white1 +
                                              ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                              month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                              month_9 + month_10 + month_11 +
                                              (1 | pseudoid),
                                            data = hf_any_data_oc_c,
                                            family = poisson(link = "log"),
                                            control = glmerControl(optimizer="bobyqa")
)


summary(hf_read7_all_c_model_glmer_spline)
```

```{r plot-7read-splines-c}
read7_c_outputs <- plot_its(hf_read7_all_c_model_glmer_spline,
                            hf_any_data_oc_c,
                            all_preds = TRUE)

read7_c_acts_preds <- read7_c_outputs$acts_preds

read7_c_outputs$plt
```

```{r}
spline_basis_read7c <- splines2::bSpline(hf_any_data_oc_c$X_t,
                                        knots = c(-6.23428),
                                        degree = 1)
```

```{r}
xt_vals <- hf_any_data_oc_c %>% distinct(X_t) %>% arrange(X_t) %>% mutate(x = row_number())

bsfns <- get_spline_eqns(spline_basis_read7c,
                         x_vals = xt_vals)

# We can also get the y = alpha + beta * x form of the linear predictor in
# each of the two regions (left and right of the knot)

coefs <-fixef(hf_read7_all_c_model_glmer_spline)
names(coefs) <- NULL

alpha <- coefs[1]
beta1 <- coefs[2]
beta2 <- coefs[3]

# Check from here.

lp <- expand_one_knot_spline_linear_predictor(beta1 = beta1,
                                        beta2 = beta2,
                                        alpha = alpha,
                                        basis_functions = bsfns,
                                        intercept = TRUE)

lp
```
```{r}
K <- get_linear_combination_for_difference_in_log_rr(spline_basis_read7c, xt_vals)

K <- ramify::resize(K, nrow = 1L, ncol = length(coefs))

K[,4:length(coefs)] <- 0

K
```

```{r}
library(multcomp)

### set up general linear hypothesis
glht_logslopediff <- glht(hf_read7_all_c_model_glmer_spline, linfct = K)
summary(glht_logslopediff)

glht_logslopediff_ci <- confint(glht_logslopediff)
glht_logslopediff_ci

confint_read7_c <- exp(glht_logslopediff_ci$confint)

pval_read7_c <- summary(glht_logslopediff)$test$pvalues[1]
results <- results %>% bind_rows(as_tibble(confint_read7_c))

results[nrow(results), "outcome"] <- "7d readmission"
results[nrow(results), "site"] <- "Control"
results[nrow(results), "pvalue"] <- pval_read7_c

results
```




```{r}
# simulationOutput <- simulateResiduals(fittedModel = hf_read7_all_nc_model_glmer_spline,
#                                       plot = F)

```



## 30-day all cause readmission rate, following discharge with HF as any diagnosis, control

```{r fit-spline-model-30-c}

hf_read30_all_c_model_glmer_spline <- glmer(allcausereadmission_30 ~ offset(log(total_HF)) +
                                              splines2::bSpline(X_t,
                                                          knots = c(-6.23428),
                                                          degree = 1) + 
                                              sexM + non_white1 +
                                              ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                              month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                              month_9 + month_10 + month_11 +
                                              (1 | pseudoid),
                                            data = hf_any_data_oc_c %>% filter(X_t <= 67 - trim_30_day),
                                            family = poisson(link = "log"),
                                            control = glmerControl(optimizer="bobyqa")
)


summary(hf_read30_all_c_model_glmer_spline)
```


```{r plot-30read-splines-c}
read30_c_outputs <- plot_its(hf_read30_all_c_model_glmer_spline,
                             hf_any_data_oc_c %>% filter(X_t <= 67 - trim_30_day),
                             add_term = TRUE,
                             all_preds = TRUE)

read30_c_acts_preds <- read30_c_outputs$acts_preds

read30_c_outputs$plt
```

```{r}
spline_basis_read30c <- splines2::bSpline(hf_any_data_oc_c$X_t,
                                        knots = c(-6.23428),
                                        degree = 1)
```

```{r}
xt_vals <- hf_any_data_oc_c %>% distinct(X_t) %>% arrange(X_t) %>% mutate(x = row_number())

bsfns <- get_spline_eqns(spline_basis_read30c,
                         x_vals = xt_vals)

# We can also get the y = alpha + beta * x form of the linear predictor in
# each of the two regions (left and right of the knot)

coefs <-fixef(hf_read30_all_c_model_glmer_spline)
names(coefs) <- NULL

alpha <- coefs[1]
beta1 <- coefs[2]
beta2 <- coefs[3]

# Check from here.

lp <- expand_one_knot_spline_linear_predictor(beta1 = beta1,
                                        beta2 = beta2,
                                        alpha = alpha,
                                        basis_functions = bsfns,
                                        intercept = TRUE)

lp
```
```{r}
K <- get_linear_combination_for_difference_in_log_rr(spline_basis_read30c, xt_vals)

K <- ramify::resize(K, nrow = 1L, ncol = length(coefs))

K[,4:length(coefs)] <- 0

K
```

```{r}
library(multcomp)

### set up general linear hypothesis
glht_logslopediff <- glht(hf_read30_all_c_model_glmer_spline, linfct = K)
summary(glht_logslopediff)

glht_logslopediff_ci <- confint(glht_logslopediff)
glht_logslopediff_ci

confint_read30_c <- exp(glht_logslopediff_ci$confint)

pval_read30_c <- summary(glht_logslopediff)$test$pvalues[1]
results <- results %>% bind_rows(as_tibble(confint_read30_c))

results[nrow(results), "outcome"] <- "30d readmission"
results[nrow(results), "site"] <- "Control"
results[nrow(results), "pvalue"] <- pval_read30_c

results
```

## 90-day all cause readmission rate, following discharge with HF as any diagnosis, control

```{r fit-spline-model-90-c}

hf_read90_all_c_model_glmer_spline <- glmer(allcausereadmission_90 ~ offset(log(total_HF)) +
                                              splines2::bSpline(X_t,
                                                          knots = c(-6.23428),
                                                          degree = 1) + 
                                              sexM + non_white1 +
                                              ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                              month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                              month_9 + month_10 + month_11 +
                                              (1 | pseudoid),
                                            data = hf_any_data_oc_c %>% filter(X_t <= 67 - trim_90_day),
                                            family = poisson(link = "log"),
                                            control = glmerControl(optimizer="bobyqa")
)


summary(hf_read90_all_c_model_glmer_spline)
```


```{r plot-90read-splines-c}
read90_c_outputs <- plot_its(hf_read90_all_c_model_glmer_spline,
                             hf_any_data_oc_c %>% filter(X_t <= 67 - trim_90_day),
                             add_term = TRUE,
                             all_preds = TRUE)

read90_c_acts_preds <- read90_c_outputs$acts_preds

read90_c_outputs$plt
```

```{r}
spline_basis_read90c <- splines2::bSpline(hf_any_data_oc_c$X_t,
                                        knots = c(-6.23428),
                                        degree = 1)
```

```{r}
xt_vals <- hf_any_data_oc_c %>% distinct(X_t) %>% arrange(X_t) %>% mutate(x = row_number())

bsfns <- get_spline_eqns(spline_basis_read90c,
                         x_vals = xt_vals)

# We can also get the y = alpha + beta * x form of the linear predictor in
# each of the two regions (left and right of the knot)

coefs <-fixef(hf_read90_all_c_model_glmer_spline)
names(coefs) <- NULL

alpha <- coefs[1]
beta1 <- coefs[2]
beta2 <- coefs[3]

# Check from here.

lp <- expand_one_knot_spline_linear_predictor(beta1 = beta1,
                                        beta2 = beta2,
                                        alpha = alpha,
                                        basis_functions = bsfns,
                                        intercept = TRUE)

lp
```
```{r}
K <- get_linear_combination_for_difference_in_log_rr(spline_basis_read90c, xt_vals)

K <- ramify::resize(K, nrow = 1L, ncol = length(coefs))

K[,4:length(coefs)] <- 0

K
```

```{r}
library(multcomp)

### set up general linear hypothesis
glht_logslopediff <- glht(hf_read90_all_c_model_glmer_spline, linfct = K)
summary(glht_logslopediff)

glht_logslopediff_ci <- confint(glht_logslopediff)
glht_logslopediff_ci

confint_read90_c <- exp(glht_logslopediff_ci$confint)

pval_read90_c <- summary(glht_logslopediff)$test$pvalues[1]
results <- results %>% bind_rows(as_tibble(confint_read90_c))

results[nrow(results), "outcome"] <- "90d readmission"
results[nrow(results), "site"] <- "Control"
results[nrow(results), "pvalue"] <- pval_read90_c

results
```

## Mortality

```{r mort-wm-oc-c, warning=TRUE, message=TRUE}
hf_any_data_oc_wm_c <- hf_any_data_oc_c %>%
  mutate(ward_4 = if_else(ward_5 == max(ward_5), max(ward_4), ward_4))

death_model_glm_wm_spline_c <- glm(as.integer(death) ~ offset(log(total_HF)) +
                            splines2::bSpline(X_t,
                                              knots = c(-6.23428),
                                              degree = 1)
                          +
                            sexM + non_white1 + ln_age +
                            ward_2 + ward_3 + ward_4 +
                            month_1 + month_2 + month_3 + month_4 + month_5 + month_6 +
                            month_7 + month_8 + month_9 + month_10 + month_11,
                          hf_any_data_oc_wm_c,
                          family = poisson(link = "log"))

summary(death_model_glm_wm_spline_c)
summary(death_model_glm_wm_spline_c)$dispersion
overdisp_fun(death_model_glm_wm_spline_c)

knitr::kable(Epi::ci.lin(death_model_glm_wm_spline_c, Exp=T))
```


```{r plot-death-splines-c}
death_c_outputs <- plot_its(death_model_glm_wm_spline_c,
                            hf_any_data_oc_c %>% filter(X_t <= 67 - trim_90_day),
                            add_term = FALSE,
                            all_preds = TRUE)


death_c_acts_preds <- death_c_outputs$acts_preds

death_c_outputs$plt
```

```{r}
spline_basis_death <- splines2::bSpline(hf_any_data_oc_wm_c$X_t,
                                        knots = c(-6.23428),
                                        degree = 1)
```

```{r}
xt_vals <- hf_any_data_oc_wm_c %>% distinct(X_t) %>% arrange(X_t) %>% mutate(x = row_number())

bsfns <- get_spline_eqns(spline_basis_death,
                         x_vals = xt_vals)

# We can also get the y = alpha + beta * x form of the linear predictor in
# each of the two regions (left and right of the knot)

coefs <- coefficients(death_model_glm_wm_spline_c)
names(coefs) <- NULL

alpha <- coefs[1]
beta1 <- coefs[2]
beta2 <- coefs[3]

# Check from here.

lp <- expand_one_knot_spline_linear_predictor(beta1 = beta1,
                                        beta2 = beta2,
                                        alpha = alpha,
                                        basis_functions = bsfns,
                                        intercept = TRUE)

lp
```
```{r}
K <- get_linear_combination_for_difference_in_log_rr(spline_basis_death, xt_vals)

K <- ramify::resize(K, nrow = 1L, ncol = length(coefs))

K[,4:length(coefs)] <- 0

K
```

```{r}
### set up general linear hypothesis
glht_logslopediff <- glht(death_model_glm_wm_spline_c, linfct = K)
summary(glht_logslopediff)

glht_logslopediff_ci <- confint(glht_logslopediff)
glht_logslopediff_ci

confint_death_c <- exp(glht_logslopediff_ci$confint)

pval_death_c <- summary(glht_logslopediff)$test$pvalues[1]
results <- results %>% bind_rows(as_tibble(confint_death_c))

results[nrow(results), "outcome"] <- "Mortality"
results[nrow(results), "site"] <- "Intervention"
results[nrow(results), "pvalue"] <- pval_death_c

results
```


## Loglos
```{r los-log-c, warning=FALSE, message=FALSE}
hf_any_data_oc_c_ll <- hf_any_data_oc_c %>%
  mutate(los_dd = log(los_dd))

# Mixed-effects linear model: random effects for pseudoid
hf_los_log_model_lmer_spline_c <- lmer(los_dd ~ splines2::bSpline(X_t,
                                                                knots = c(-6.23428),
                                                                degree = 1) +
                                       sexM + non_white1 +
                                       ln_age + ward_2 + ward_3 + ward_4 + ward_5 + month_1 + month_2 +
                                       month_3 + month_4 + month_5 + month_6 + month_7 + month_8 +
                                       month_9 + month_10 + month_11 +
                                       (1 | pseudoid),
                                     hf_any_data_oc_c_ll)

summary(hf_los_log_model_lmer_spline_c)


# Display coefficients
#knitr::kable(fixef(hf_los_log_model_lmer), col.names = c("coeffs"))
knitr::kable(exp(fixef(hf_los_log_model_lmer_spline_c)), col.names = c("exp_coeffs"))
```


```{r plot-los-splines-c}
los_c_outputs <- plot_its(hf_los_log_model_lmer_spline_c,
                          hf_any_data_oc_c %>%
                            mutate(los_dd = log(los_dd)),
                          add_term = FALSE,
                          all_preds = TRUE,
                          los_model = TRUE)


los_c_acts_preds <- los_c_outputs$acts_preds

los_c_outputs$plt
```

```{r}
spline_basis_los <- splines2::bSpline(hf_any_data_oc_c_ll$X_t,
                                        knots = c(-6.23428),
                                        degree = 1)
```

```{r}
xt_vals <- hf_any_data_oc_c_ll %>% distinct(X_t) %>% arrange(X_t) %>% mutate(x = row_number())

bsfns <- get_spline_eqns(spline_basis_los,
                         x_vals = xt_vals)

# We can also get the y = alpha + beta * x form of the linear predictor in
# each of the two regions (left and right of the knot)

coefs <-fixef(hf_los_log_model_lmer_spline_c)
names(coefs) <- NULL

alpha <- coefs[1]
beta1 <- coefs[2]
beta2 <- coefs[3]

# Check from here.

lp <- expand_one_knot_spline_linear_predictor(beta1 = beta1,
                                        beta2 = beta2,
                                        alpha = alpha,
                                        basis_functions = bsfns,
                                        intercept = TRUE)

lp
```
```{r}
K <- get_linear_combination_for_difference_in_log_rr(spline_basis_los, xt_vals)

K <- ramify::resize(K, nrow = 1L, ncol = length(coefs))

K[,4:length(coefs)] <- 0

K
```

```{r}
### set up general linear hypothesis
glht_logslopediff <- glht(hf_los_log_model_lmer_spline_c, linfct = K)
summary(glht_logslopediff)

glht_logslopediff_ci <- confint(glht_logslopediff)
glht_logslopediff_ci

confint_los_c <- exp(glht_logslopediff_ci$confint)

pval_los_c <- summary(glht_logslopediff)$test$pvalues[1]
results <- results %>% bind_rows(as_tibble(confint_los_c))

results[nrow(results), "outcome"] <- "Length of stay"
results[nrow(results), "site"] <- "Control"
results[nrow(results), "pvalue"] <- pval_los_c

results
```

# Combined results

```{r}
acts_preds <- bind_rows(read7_acts_preds %>% mutate(outcome = "7d readmission (%)", site = "Intervention"),
                        read30_acts_preds %>% mutate(outcome = "30d readmission (%)", site = "Intervention"),
                        read90_acts_preds %>% mutate(outcome = "90d readmission (%)", site = "Intervention"),
                        death_acts_preds %>% mutate(outcome = "Mortality (%)", site = "Intervention"),
                        los_acts_preds %>% mutate(outcome = "Length of stay (days)", site = "Intervention"),
                        read7_c_acts_preds %>% mutate(outcome = "7d readmission (%)", site = "Control"),
                        read30_c_acts_preds %>% mutate(outcome = "30d readmission (%)", site = "Control"),
                        read90_c_acts_preds %>% mutate(outcome = "90d readmission (%)", site = "Control"),
                        death_c_acts_preds %>% mutate(outcome = "Mortality (%)", site = "Control"),
                        los_c_acts_preds %>% mutate(outcome = "Length of stay (days)", site = "Control")) %>% 
  mutate(across(all_of(c("act_rate", "pred_rate", "pred_rate_prepost", "pred_rate_monthly")),
                ~ if_else(outcome == "Length of stay (days)", .x, .x * 100))) %>%
  mutate(outcome = factor(outcome,
                          levels = c("7d readmission (%)", "30d readmission (%)",
                                     "90d readmission (%)", "Mortality (%)",
                                     "Length of stay (days)")))

year_month <- seq(as.Date("2012-01-01"), as.Date("2017-07-01"), by = "month")
year_month <- tibble::tibble(year_month) %>% tibble::rowid_to_column(var = "id_time") 
acts_preds <- acts_preds %>%
  left_join(year_month,
            by = join_by(id_time))

# Position for intervention line on plot - halfway between two months
intervention_month <- year_month %>% filter(id_time == 42) %>% pull(year_month) + 15
```

```{r spline-plot-ic, fig.height=8, fig.width=7}
plt <- acts_preds %>%
  dplyr::select(id_time, year_month, act_rate, pred_rate, pred_rate_prepost, pred_rate_monthly, outcome, site) %>%
  ggplot2::ggplot(ggplot2::aes(x=year_month)) +
  ggplot2::geom_line(ggplot2::aes(y=pred_rate), colour = "cornflowerblue") +
  ggplot2::geom_line(ggplot2::aes(y=pred_rate_prepost), colour = "blue") +
  ggplot2::geom_line(ggplot2::aes(y=pred_rate_monthly), colour = "darkslategrey") +
  ggplot2::geom_point(ggplot2::aes(y=act_rate), colour = "black", size = 0.5) +
  ggplot2::facet_grid(rows = vars(outcome), cols = vars(site), scales = "free_y") +
  ylim(0, NA) +
  theme(panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_vline(xintercept = intervention_month, linetype="dotted") +
  scale_x_date(breaks = seq(as.Date("2012-01-01"), as.Date("2017-07-01"), by = "6 months"),
               labels = scales::date_format("%b %Y")) +
  labs(title = "Figure 1: Interrupted Time Series Analysis of Heart Failure Admission Outcomes",
       subtitle = "Time series with continuous time trends pre- and post-intervention",
       x = "Time (months)", y = NULL)

plt
```

```{r}
results %>%
  dplyr::select(outcome, site, Estimate, lwr, upr, pvalue) %>% 
  knitr::kable()
```






