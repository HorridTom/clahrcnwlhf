---
title: "Descriptive Analysis for CLAHRC NWL Heart Failure Care Bundle"
author: "Dr. Thomas Woodcock"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette covers the descriptive data analysis for the evaluation of the
CLAHRC NWL Heart Failure Care Bundle project at North West London Hospitals.

This assumes the `clahrcnwlhf::admission_data` data has been cleaned using `clahrcnwlhf::clean_and_save`. As of 1st December 2016 this includes all
discharges after 1st January 2012 and 30th September 2016 inclusive.

## Dataset

This part of the analysis will focus on emergency admissions data; in other
words those episodes for which
'admission_data_clean$AdmissionType = "Emergency"'. Let us first restrict the
dataset to only these episodes

```{r, echo=TRUE, results='asis', cache=TRUE}
emergency_adms <- clahrcnwlhf::admission_data_clean[
  which(clahrcnwlhf::admission_data_clean[,"AdmissionType"] == "Emergency"),]

```

This leaves us with `r nrow(emergency_adms)` emergency episodes with discharge
date between 1st January 2012 and 30th September 2016 inclusive. We will need to
identify those episodes and spells with a primary diagnosis of heart failure,
and with any diagnosis of heart failure so let us add flag columns to indicate
such episodes.

```{r, echo=TRUE, results='asis', cache=TRUE}
emergency_adms <- clahrcnwlhf::make_diag_flag(emergency_adms,
                                   code_regex="I110|I255|I420|I429|I500|I501|I509",
                                   new_colname = "Heart.Failure.Episode")
emergency_adms <- clahrcnwlhf::make_anydiag_flag(emergency_adms, "Diagnosis", "HF.any.code", "I110|I255|I420|I429|I500|I501|I509")

```

We will need a spell number variable, to identify which episodes are part of the
same spell. The following code creates this column, along with some helper
columns.

```{r, echo=TRUE, results='asis', cache=TRUE}
#emergency_adms <- clahrcnwlhf::new.pat(emergency_adms, id = "PseudoID",
#                                         adt = "CSPAdmissionTime")
#emergency_adms <- clahrcnwlhf::new_spell(emergency_adms)

#emergency_adms <- clahrcnwlhf::make.spellnumber.2(emergency_adms)

#The function make.spellnumber.2 takes some time to run. To save time, load this
#dataset in directly. All previous operations in this vignette have been
#performed on this saved dataset by clahrcnwlhf::make_emergency_adms_dataset
emergency_adms <- clahrcnwlhf::emergency_adms

```

This results in `r max(emergency_adms$spell_number)` emergency spells with
discharge date between 1st January 2012 and 30th September 2016 inclusive.

## Number of Discharges by Month

Let us first restrict attention to only the first episode of each spell.

```{r, echo=TRUE, results='asis', cache=TRUE}
emergency_spells <- emergency_adms[
  which(emergency_adms[,"EpisodeNumber"] == 1),]

```

This gives `r nrow(emergency_spells)` discharges between 1st January 2012 and
30th September 2016 inclusive. Let us see how these vary by month over this
period.


```{r, fig.height=5, fig.width=7, cache=TRUE}

n_disch <- clahrcnwlhf::disch_time_table(emergency_spells)
#n_disch <- n_disch[-length(n_disch)]

matplot(n_disch, type = c("b"), pch=20, col = 1, xaxt="n", ylim=c(0,6500))
axis(side=1,at=1:length(n_disch),labels=names(n_disch))
```
Without a field for which hospital the episode was located at, I cannot split
this down by hospital at this point. This will be done on revisiting
Northwick Park. (2016-12-02)

Next let's look at this for those spells with primary diagnosis code
heart failure.

```{r, fig.height=5, fig.width=7, cache=TRUE}

n_disch <- clahrcnwlhf::disch_time_table(emergency_spells[
  which(emergency_spells[,"Heart.Failure.Episode"] == TRUE),])
#n_disch <- n_disch[-length(n_disch)]

matplot(n_disch, type = c("b"), pch=20, col = 1, xaxt="n", ylim=c(0,100))
axis(side=1,at=1:length(n_disch),labels=names(n_disch))
```

There are a total of `r sum(n_disch)` spells with primary diagnosis code
heart failure for the period. 

For comparison, the number of heart failure ***episodes***:

```{r, fig.height=5, fig.width=7, cache=TRUE}
emergency_adms <- clahrcnwlhf::make_diag_flag(emergency_adms,
                                   code_regex="I110|I255|I420|I429|I500|I501|I509",
                                   new_colname = "Heart.Failure.Episode")
n_disch <- clahrcnwlhf::disch_time_table(emergency_adms[
  which(emergency_adms[,"Heart.Failure.Episode"] == TRUE),])

matplot(n_disch, type = c("b"), pch=20, col = 1, xaxt="n", ylim=c(0,300))
axis(side=1,at=1:length(n_disch),labels=names(n_disch))
```

## Other diagnosis positions

We will now look at admission numbers for patients with a diagnosis code in positions
other than Primary Diagnosis.

```{r, fig.height=5, fig.width=7, cache=TRUE}

n_disch <- clahrcnwlhf::disch_time_table(emergency_spells[
  which(emergency_spells[,"HF.any.code"] == TRUE),])
#n_disch <- n_disch[-length(n_disch)]

matplot(n_disch, type = c("b"), pch=20, col = 1, xaxt="n", ylim=c(0,800))
axis(side=1,at=1:length(n_disch),labels=names(n_disch))
```


## Readmissions






